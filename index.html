<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>機台收支管理系統 Pro V6</title>
    
    <!-- React & Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #030305;
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        /* --- 高級動態背景 --- */
        .cyber-bg {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: 
                radial-gradient(circle at 15% 50%, rgba(76, 29, 149, 0.15) 0%, transparent 25%), 
                radial-gradient(circle at 85% 30%, rgba(37, 99, 235, 0.15) 0%, transparent 25%);
            z-index: -2;
        }
        /* 雜訊質感 */
        .noise-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZmlsdGVyIGlkPSJub2lzZSI+PHBmZVR1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjY1IiBudW1PY3RhdmVzPSIzIiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI25vaXNlKSIgb3BhY2l0eT0iMC4wNSIvPjwvc3ZnPg==');
            pointer-events: none;
            z-index: -1;
            opacity: 0.4;
        }

        /* --- 鑽石級玻璃擬態 --- */
        .glass-dock {
            background: rgba(18, 18, 23, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
        }
        
        .glass-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.03) 0%, rgba(255, 255, 255, 0.01) 100%);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-left: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 24px -1px rgba(0, 0, 0, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass-card:active {
            transform: scale(0.98);
            background: rgba(255, 255, 255, 0.05);
        }

        .glass-modal {
            background: rgba(10, 10, 12, 0.85);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 -20px 60px rgba(0,0,0,0.6);
        }

        /* --- 霓虹輸入框 --- */
        .hk-input-group {
            position: relative;
            background: rgba(0,0,0,0.3);
            border-radius: 16px;
            padding: 2px;
            background-clip: padding-box;
            border: 1px solid rgba(255,255,255,0.1);
            transition: all 0.3s;
        }
        .hk-input-group:focus-within {
            border-color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.15);
        }
        .hk-input {
            background: transparent;
            border: none;
            color: white;
            padding: 14px 16px;
            font-size: 1rem;
            width: 100%;
            outline: none;
        }
        
        .font-mono-num { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .text-glow-blue { text-shadow: 0 0 10px rgba(59, 130, 246, 0.5); }
        .text-glow-green { text-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
        .text-glow-red { text-shadow: 0 0 10px rgba(239, 68, 68, 0.5); }
    </style>
</head>
<body>
    <div class="cyber-bg"></div>
    <div class="noise-overlay"></div>
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyBJ0qf4FyJ-Ln8uTlVfyqq84IAeUsTWSCo",
            authDomain: "recordmachine.firebaseapp.com",
            projectId: "recordmachine",
            storageBucket: "recordmachine.firebasestorage.app",
            messagingSenderId: "817708522720",
            appId: "1:817708522720:web:5e3b876ce170012d53c485",
            measurementId: "G-WR49R47LN1"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Icon Component ---
        const Icon = ({ name, size=24, className="", ...props }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current && window.lucide.icons[name]) {
                    const svg = window.lucide.createElement(window.lucide.icons[name]);
                    svg.setAttribute('width', size);
                    svg.setAttribute('height', size);
                    svg.setAttribute('class', className);
                    ref.current.innerHTML = '';
                    ref.current.appendChild(svg);
                }
            }, [name, size, className]);
            return <span ref={ref} {...props} className={`inline-flex items-center justify-center ${className}`} />;
        };

        // --- UI Components ---
        
        const FloatingDock = ({ current, setView }) => {
            const tabs = [
                { id: 'accounting', label: '記數', icon: 'Calculator' },
                { id: 'data', label: '資料', icon: 'FolderOpen' },
                { id: 'video', label: '影片', icon: 'Film' },
                { id: 'clock', label: '打卡', icon: 'Timer' },
                { id: 'summary', label: '結算', icon: 'PieChart' },
                { id: 'settings', label: '設定', icon: 'Settings2' }
            ];

            return (
                <div className="fixed bottom-6 inset-x-4 z-50">
                    <div className="glass-dock rounded-2xl h-20 flex justify-between items-center px-2 max-w-lg mx-auto">
                        {tabs.map((tab) => {
                            const active = current === tab.id;
                            return (
                                <button
                                    key={tab.id}
                                    onClick={() => setView(tab.id)}
                                    className="relative flex flex-col items-center justify-center flex-1 h-full group"
                                >
                                    {active && (
                                        <motion.div 
                                            layoutId="dock-glow"
                                            className="absolute top-2 w-10 h-10 bg-blue-500/20 rounded-xl blur-md border border-blue-500/30"
                                            transition={{ type: "spring", stiffness: 300, damping: 30 }}
                                        />
                                    )}
                                    <div className={`relative transition-all duration-300 transform ${active ? '-translate-y-1 scale-110 text-white' : 'text-slate-500'}`}>
                                        <Icon name={tab.icon} size={24} />
                                    </div>
                                    <span className={`text-[10px] font-medium mt-1 transition-colors ${active ? 'text-blue-300' : 'text-slate-600'}`}>
                                        {tab.label}
                                    </span>
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        };

        const CardStat = ({ label, value, type }) => {
            const colors = {
                green: "text-emerald-400 text-glow-green",
                red: "text-rose-400 text-glow-red",
                blue: "text-blue-400 text-glow-blue",
                yellow: "text-amber-400"
            };
            return (
                <div className="glass-card p-4 rounded-2xl flex flex-col justify-between h-24 relative overflow-hidden">
                    <div className="absolute top-0 right-0 p-2 opacity-10">
                        <Icon name={type==='stock'?'TrendingDown':'TrendingUp'} size={40}/>
                    </div>
                    <div className="text-[10px] text-slate-400 uppercase tracking-widest font-bold">{label}</div>
                    <div className={`font-mono-num font-bold text-lg ${colors[type] || 'text-white'}`}>
                        {value}
                    </div>
                </div>
            );
        };

        // --- Share Center ---
        const ShareCenter = ({ user, onClose, onSwitchUser }) => {
            const [activeTab, setActiveTab] = useState('mine'); 
            const [myShares, setMyShares] = useState([]);
            const [sharedWithMe, setSharedWithMe] = useState([]);
            const [inviteEmail, setInviteEmail] = useState('');

            useEffect(() => {
                if(user.isGuest) return;
                const u1 = db.collection('artifacts').doc('recordmachine').collection('public').doc('data').collection('shares').where('ownerUid', '==', user.uid).onSnapshot(s => setMyShares(s.docs.map(d=>({id:d.id,...d.data()}))));
                const u2 = db.collection('artifacts').doc('recordmachine').collection('public').doc('data').collection('shares').where('allowedEmail', '==', user.email).onSnapshot(s => setSharedWithMe(s.docs.map(d=>({id:d.id,...d.data()}))));
                return () => { u1(); u2(); };
            }, [user]);

            const sendInvite = async () => {
                if(!inviteEmail) return;
                await db.collection('artifacts').doc('recordmachine').collection('public').doc('data').collection('shares').add({
                    ownerUid: user.uid, ownerEmail: user.email, allowedEmail: inviteEmail, createdAt: new Date().toISOString(), permissions: { accounting:true, data:true, video:true, clock:true, summary:true }
                });
                setInviteEmail('');
            };

            const togglePerm = async (id, k, v) => db.collection('artifacts').doc('recordmachine').collection('public').doc('data').collection('shares').doc(id).set({permissions:{[k]:!v}},{merge:true});
            const delShare = async (id) => { if(confirm("停止分享？")) await db.collection('artifacts').doc('recordmachine').collection('public').doc('data').collection('shares').doc(id).delete(); };

            return (
                <div className="fixed inset-0 z-[70] bg-black/90 backdrop-blur-md flex items-center justify-center p-4">
                    <motion.div initial={{scale:0.95,opacity:0}} animate={{scale:1,opacity:1}} className="glass-modal w-full max-w-lg rounded-3xl p-6 h-[80vh] flex flex-col border border-slate-700/50">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold flex items-center gap-2 text-white"><Icon name="Share2" className="text-blue-400"/> 分享中樞</h2>
                            <button onClick={onClose} className="p-2 bg-white/5 rounded-full hover:bg-white/10"><Icon name="X" size={20}/></button>
                        </div>
                        <div className="flex p-1 bg-slate-900/50 rounded-xl mb-6 border border-white/5">
                            <button onClick={()=>setActiveTab('mine')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${activeTab==='mine'?'bg-blue-600 text-white shadow-lg':'text-slate-400'}`}>我的分享</button>
                            <button onClick={()=>setActiveTab('others')} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-all ${activeTab==='others'?'bg-purple-600 text-white shadow-lg':'text-slate-400'}`}>接收的分享</button>
                        </div>
                        <div className="flex-1 overflow-y-auto no-scrollbar space-y-4">
                            {activeTab === 'mine' ? (
                                <>
                                    <div className="hk-input-group flex items-center pr-2 mb-4">
                                        <input value={inviteEmail} onChange={e=>setInviteEmail(e.target.value)} placeholder="對方 Email" className="hk-input text-sm"/>
                                        <button onClick={sendInvite} className="bg-blue-600 px-4 py-2 rounded-lg font-bold text-xs">邀請</button>
                                    </div>
                                    <div className="space-y-4">
                                        {myShares.map(s => (
                                            <div key={s.id} className="bg-slate-800/40 p-4 rounded-2xl border border-white/5">
                                                <div className="flex justify-between items-center mb-3">
                                                    <span className="text-sm font-bold text-slate-200">{s.allowedEmail}</span>
                                                    <button onClick={()=>delShare(s.id)} className="text-red-400"><Icon name="Trash2" size={16}/></button>
                                                </div>
                                                <div className="grid grid-cols-5 gap-1">
                                                    {['accounting','data','video','clock','summary'].map(k => {
                                                        const active = s.permissions?.[k] !== false;
                                                        const icons = {accounting:'Calculator',data:'Folder',video:'Film',clock:'Timer',summary:'PieChart'};
                                                        return (
                                                            <button key={k} onClick={()=>togglePerm(s.id,k,active)} className={`h-8 rounded flex items-center justify-center transition-colors ${active?'bg-green-500/20 text-green-400 border border-green-500/30':'bg-red-500/10 text-slate-600 border border-transparent'}`}>
                                                                <Icon name={icons[k]} size={14}/>
                                                            </button>
                                                        )
                                                    })}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </>
                            ) : (
                                <div className="space-y-3">
                                    {sharedWithMe.map(s => (
                                        <button key={s.id} onClick={()=>{onSwitchUser(s); onClose();}} className="w-full bg-slate-800/40 p-4 rounded-2xl border border-white/5 flex justify-between items-center hover:bg-slate-700 transition-colors">
                                            <div className="text-left">
                                                <div className="text-[10px] text-slate-400 uppercase">Owner</div>
                                                <div className="font-bold text-sm">{s.ownerEmail}</div>
                                            </div>
                                            <div className="bg-purple-600/20 text-purple-300 border border-purple-500/30 px-3 py-1 rounded-lg text-xs font-bold">進入 View</div>
                                        </button>
                                    ))}
                                    {sharedWithMe.length===0 && <div className="text-center text-slate-500 mt-10">暫無記錄</div>}
                                </div>
                            )}
                        </div>
                    </motion.div>
                </div>
            );
        };

        // --- Edit Modal ---
        const EditModal = ({ record, onClose, onUpdate, onDelete, settings }) => {
            const [form, setForm] = useState({ ...record });
            if (!record) return null;
            const handleSave = () => onUpdate({ ...record, ...form });

            return (
                <div className="fixed inset-0 z-[60] bg-black/80 backdrop-blur-md flex items-end sm:items-center justify-center p-0 sm:p-4">
                    <motion.div initial={{ y: "100%" }} animate={{ y: 0 }} exit={{ y: "100%" }} className="glass-modal w-full max-w-lg rounded-t-3xl sm:rounded-3xl p-6 pb-safe space-y-5">
                        <div className="flex justify-between items-center">
                            <h3 className="text-xl font-bold text-white flex items-center gap-2"><Icon name="Edit3" size={20} className="text-blue-400"/> 編輯記錄</h3>
                            <button onClick={onClose} className="p-2 bg-white/5 rounded-full"><Icon name="X" size={20}/></button>
                        </div>
                        <div className="space-y-4 max-h-[60vh] overflow-y-auto no-scrollbar">
                            <div className="hk-input-group"><input type="date" value={form.date} onChange={e=>setForm({...form, date:e.target.value})} className="hk-input" /></div>
                            
                            {record.type === 'machine' && (
                                <>
                                    <div className="hk-input-group border-green-500/30"><input type="number" value={form.amount} onChange={e=>setForm({...form, amount:Number(e.target.value)})} className="hk-input text-green-400 font-bold text-lg font-mono-num" /></div>
                                    <div className="hk-input-group"><select value={form.venue} onChange={e=>setForm({...form, venue:e.target.value})} className="hk-input bg-transparent text-white"><option value="" disabled>選擇場地</option>{settings.venues.map(v=><option key={v} value={v} className="bg-slate-900">{v}</option>)}</select></div>
                                    <div className="hk-input-group"><input value={form.notes} onChange={e=>setForm({...form, notes:e.target.value})} className="hk-input" placeholder="備註" /></div>
                                </>
                            )}
                            
                            {record.type === 'stock' && (
                                <>
                                    <div className="hk-input-group border-red-500/30"><input type="number" value={form.amount} onChange={e=>setForm({...form, amount:Number(e.target.value)})} className="hk-input text-red-400 font-bold text-lg font-mono-num" /></div>
                                    <div className="hk-input-group"><input value={form.itemName} onChange={e=>setForm({...form, itemName:e.target.value})} className="hk-input" /></div>
                                </>
                            )}

                            {record.type === 'video' && <div className="hk-input-group"><input value={form.title} onChange={e=>setForm({...form, title:e.target.value})} className="hk-input" /></div>}
                            {record.type === 'clockin' && <div className="hk-input-group border-yellow-500/30"><input value={form.amount} onChange={e=>setForm({...form, amount:Number(e.target.value)})} className="hk-input text-yellow-400 font-bold font-mono-num" /></div>}
                        </div>
                        <div className="grid grid-cols-2 gap-3 pt-2">
                            <button onClick={() => onDelete(record.id)} className="py-4 bg-red-500/10 text-red-400 border border-red-500/20 rounded-2xl font-bold flex items-center gap-2 justify-center hover:bg-red-500/20 transition-colors"><Icon name="Trash2" size={18}/> 刪除</button>
                            <button onClick={handleSave} className="py-4 bg-blue-600 text-white rounded-2xl font-bold flex items-center gap-2 justify-center shadow-[0_0_20px_rgba(37,99,235,0.4)] hover:scale-[1.02] transition-transform"><Icon name="Save" size={18}/> 儲存</button>
                        </div>
                    </motion.div>
                </div>
            );
        };

        // --- Main App Logic ---

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('accounting');
            const [records, setRecords] = useState([]);
            const [settings, setSettings] = useState({ venues: ['旺角中心','現時點','信和中心'], sources: ['淘寶','日拍'], nickname: '機主' });
            const [monthlyEst, setMonthlyEst] = useState(0);
            
            // Share States
            const [showShareModal, setShowShareModal] = useState(false);
            const [viewingUser, setViewingUser] = useState(null);
            const [activePermissions, setActivePermissions] = useState(null);
            const [editingRecord, setEditingRecord] = useState(null);
            const [isOnline, setIsOnline] = useState(navigator.onLine);

            useEffect(() => {
                const handleStatusChange = () => setIsOnline(navigator.onLine);
                window.addEventListener('online', handleStatusChange);
                window.addEventListener('offline', handleStatusChange);
                return () => {
                    window.removeEventListener('online', handleStatusChange);
                    window.removeEventListener('offline', handleStatusChange);
                };
            }, []);

            useEffect(() => {
                auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser({ ...u, isGuest: false, displayName: u.displayName || '未命名' });
                        loadData(u.uid);
                    } else {
                        const g = localStorage.getItem('guest');
                        if (g) { setUser(JSON.parse(g)); loadGuestData(); }
                    }
                });
            }, []);

            // Permission Listener
            useEffect(() => {
                if (viewingUser) {
                    const unsub = db.collection('artifacts').doc('recordmachine').collection('public').doc('data').collection('shares').doc(viewingUser.id)
                        .onSnapshot(doc => {
                            if(doc.exists) setActivePermissions(doc.data().permissions || {});
                            else { alert("分享已停止"); setViewingUser(null); }
                        });
                    return () => unsub();
                } else {
                    setActivePermissions(null);
                }
            }, [viewingUser]);

            useEffect(() => {
                if (!records.length) { setMonthlyEst(0); return; }
                const ym = new Date().toISOString().slice(0, 7);
                const total = records.filter(r => r.date.startsWith(ym) && ['machine', 'video', 'clockin'].includes(r.type)).reduce((sum, r) => sum + (Number(r.amount) || 0), 0);
                setMonthlyEst(total);
            }, [records]);

            const loadData = async (uid) => {
                const s = await db.collection('artifacts').doc('recordmachine').collection('users').doc(uid).collection('settings').doc('profile').get();
                if (s.exists) setSettings(prev => ({...prev, ...s.data()}));
                const r = await db.collection('artifacts').doc('recordmachine').collection('users').doc(uid).collection('records').orderBy('date', 'desc').limit(200).get();
                setRecords(r.docs.map(d => ({id: d.id, ...d.data()})));
            };

            const loadGuestData = () => {
                setRecords(JSON.parse(localStorage.getItem('guest_records') || '[]'));
                setSettings(JSON.parse(localStorage.getItem('guest_settings') || JSON.stringify(settings)));
            };

            const switchViewUser = async (shareObj) => {
                if (!shareObj) {
                    setViewingUser(null);
                    loadData(user.uid);
                } else {
                    setViewingUser(shareObj);
                    setActivePermissions(shareObj.permissions || {});
                    const r = await db.collection('artifacts').doc('recordmachine').collection('users').doc(shareObj.ownerUid).collection('records').orderBy('date', 'desc').limit(200).get();
                    setRecords(r.docs.map(d => ({id: d.id, ...d.data()})));
                    const s = await db.collection('artifacts').doc('recordmachine').collection('users').doc(shareObj.ownerUid).collection('settings').doc('profile').get();
                    if(s.exists) setSettings(prev => ({...prev, ...s.data()}));
                }
            };

            // CRUD Handlers (FIXED)
            const handleAdd = async (d) => {
                const nr = { ...d, id: Math.random().toString(36).slice(2), createdAt: new Date().toISOString() };
                const ns = [nr, ...records];
                setRecords(ns);
                if (!user.isGuest) {
                    await db.collection('artifacts').doc('recordmachine').collection('users').doc(user.uid).collection('records').doc(nr.id).set(nr);
                } else {
                    localStorage.setItem('guest_records', JSON.stringify(ns));
                }
            };

            const handleUpdate = async (d) => {
                const ns = records.map(r => r.id === d.id ? d : r);
                setRecords(ns);
                if (!user.isGuest) {
                    await db.collection('artifacts').doc('recordmachine').collection('users').doc(user.uid).collection('records').doc(d.id).set(d, { merge: true });
                } else {
                    localStorage.setItem('guest_records', JSON.stringify(ns));
                }
                setEditingRecord(null);
            };

            const handleDelete = async (id) => {
                if (!confirm("刪除?")) return;
                const ns = records.filter(r => r.id !== id);
                setRecords(ns);
                if (!user.isGuest) {
                    await db.collection('artifacts').doc('recordmachine').collection('users').doc(user.uid).collection('records').doc(id).delete();
                } else {
                    localStorage.setItem('guest_records', JSON.stringify(ns));
                }
                setEditingRecord(null);
            };
            
            if (!user) return <Login onLogin={(u) => { setUser(u); if(u.isGuest) loadGuestData(); }} />;

            const isBlocked = viewingUser && activePermissions && activePermissions[view] === false;

            return (
                <div className="min-h-screen pb-28">
                    {/* Top Bar */}
                    <div className="fixed top-0 inset-x-0 z-40 bg-black/60 backdrop-blur-md border-b border-white/5 px-4 pt-12 pb-3 flex justify-between items-center">
                        
                        {/* LEFT: User & Title */}
                        <div className="flex flex-col w-1/3">
                            <div className="flex items-center gap-1.5 mb-0.5">
                                <span className={`text-[9px] font-bold px-1.5 py-0.5 rounded border ${viewingUser ? 'bg-purple-500/20 border-purple-500 text-purple-300' : 'bg-blue-600/20 border-blue-500 text-blue-300'}`}>
                                    {viewingUser ? 'VIEW' : 'OWNER'}
                                </span>
                                <span className="text-[10px] font-bold text-slate-300 truncate max-w-[80px]">{viewingUser ? viewingUser.ownerEmail : user?.displayName}</span>
                            </div>
                            <h1 className="text-lg font-black tracking-wide text-white leading-tight">
                                機台收支
                            </h1>
                            <p className="text-[9px] text-blue-500 font-bold tracking-widest leading-none">
                                (V6.0 旗艦版)
                            </p>
                        </div>

                        {/* CENTER: Cards (Capsule Style) */}
                        <div className="flex flex-col items-center justify-center gap-1.5 w-1/3">
                            {/* Status Card */}
                            <div className="glass-card px-3 py-1 rounded-full flex items-center justify-center gap-1.5 border border-white/10 bg-black/30 w-full max-w-[100px]">
                                <span className={`relative flex h-1.5 w-1.5`}>
                                  <span className={`animate-ping absolute inline-flex h-full w-full rounded-full opacity-75 ${isOnline ? 'bg-emerald-400' : 'bg-red-400'}`}></span>
                                  <span className={`relative inline-flex rounded-full h-1.5 w-1.5 ${isOnline ? 'bg-emerald-500' : 'bg-red-500'}`}></span>
                                </span>
                                <span className={`text-[9px] font-bold ${isOnline ? 'text-emerald-400' : 'text-red-400'}`}>{isOnline ? '連線' : '離線'}</span>
                            </div>
                            {/* Revenue Card */}
                            <div className="glass-card px-3 py-1 rounded-full border border-white/10 bg-black/30 text-center w-full max-w-[100px] flex justify-between items-center">
                                <span className="text-[8px] text-slate-500 uppercase font-bold mr-1">預收</span>
                                <span className="text-[10px] font-mono-num font-bold text-emerald-400">${monthlyEst.toLocaleString()}</span>
                            </div>
                        </div>

                        {/* RIGHT: Buttons */}
                        <div className="flex items-center justify-end gap-2 w-1/3">
                            {viewingUser && (
                                <button onClick={()=>switchViewUser(null)} className="p-2 rounded-full bg-red-500/20 text-red-400 border border-red-500/30 hover:bg-red-500/30 transition-colors">
                                    <Icon name="LogOut" size={16}/>
                                </button>
                            )}
                            {!user.isGuest && (
                                <>
                                    <button onClick={()=>setView('settings')} className="p-2 rounded-full bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700 transition-colors">
                                        <Icon name="Settings2" size={18}/>
                                    </button>
                                    <button onClick={()=>setShowShareModal(true)} className="p-2 rounded-full bg-blue-600 text-white shadow-[0_0_15px_#2563eb] hover:bg-blue-500 transition-colors">
                                        <Icon name={viewingUser ? "Eye" : "Share2"} size={18}/>
                                    </button>
                                </>
                            )}
                        </div>
                    </div>

                    <main className="pt-36 px-4 container mx-auto max-w-lg">
                        <AnimatePresence mode="wait">
                            {isBlocked ? (
                                <motion.div key="blocked" initial={{opacity:0, scale:0.9}} animate={{opacity:1, scale:1}} className="h-[50vh] flex flex-col items-center justify-center text-center p-6 glass-card rounded-3xl border-red-500/30">
                                    <div className="p-6 bg-red-500/10 rounded-full mb-4 border border-red-500/30 shadow-[0_0_30px_rgba(239,68,68,0.2)]"><Icon name="Lock" size={48} className="text-red-500"/></div>
                                    <h2 className="text-xl font-bold text-red-400">存取被拒絕 Access Denied</h2>
                                    <p className="text-sm text-slate-500 mt-2">擁有者已隱藏此頁面內容</p>
                                </motion.div>
                            ) : (
                                <motion.div key={view} initial={{opacity:0, y:10}} animate={{opacity:1, y:0}} exit={{opacity:0, y:-10}} transition={{duration:0.25}}>
                                    {view === 'accounting' && <Accounting records={records} onAdd={handleAdd} onEdit={setEditingRecord} settings={settings} readOnly={!!viewingUser} />}
                                    {view === 'data' && <DataFolder records={records} onEdit={!viewingUser ? setEditingRecord : undefined} />}
                                    {view === 'video' && <VideoPage records={records} onAdd={handleAdd} onEdit={setEditingRecord} readOnly={!!viewingUser} />}
                                    {view === 'clock' && <ClockPage records={records} onAdd={handleAdd} onEdit={setEditingRecord} user={settings.nickname} readOnly={!!viewingUser} />}
                                    {view === 'summary' && <Summary records={records} />}
                                    {view === 'settings' && <SettingsPage user={user} settings={settings} onUpdate={(s)=>setSettings(s)} logout={() => {setUser(null); auth.signOut();}} readOnly={!!viewingUser} />}
                                </motion.div>
                            )}
                        </AnimatePresence>
                    </main>

                    <FloatingDock current={view} setView={setView} />
                    
                    <AnimatePresence>
                        {editingRecord && !viewingUser && <EditModal record={editingRecord} onClose={()=>setEditingRecord(null)} onUpdate={handleUpdate} onDelete={handleDelete} settings={settings} />}
                        {showShareModal && <ShareCenter user={user} onClose={()=>setShowShareModal(false)} onSwitchUser={switchViewUser} />}
                    </AnimatePresence>
                </div>
            );
        };

        // --- Sub-Pages (Refined) ---
        
        const Accounting = ({ records, onAdd, onEdit, settings, readOnly }) => {
            const [mode, setMode] = useState('machine');
            const [form, setForm] = useState({date: new Date().toISOString().split('T')[0], venue: settings.venues[0], mType: 'std', amt: '', top: '', bot: '', note: '', source: settings.sources[0], item: '', qty: '', cost: ''});
            
            const submit = () => {
                if(readOnly) return;
                if(mode==='machine') { 
                    const tot = form.mType==='std' ? Number(form.amt) : Number(form.top)+Number(form.bot);
                    if(!tot) return alert('請輸入金額');
                    onAdd({type:'machine',...form,amount:tot,details:form.mType==='mini'?{top:form.top,bot:form.bot}:null}); 
                } else { 
                    if(!form.cost) return alert('請輸入成本');
                    onAdd({type:'stock',...form,amount:Number(form.cost)}); 
                }
                setForm({...form,amt:'',top:'',bot:'',cost:''});
            };

            return (
                <div className="space-y-6">
                    <div className="flex gap-4 p-1 bg-slate-900/50 rounded-2xl border border-white/5">
                        {['machine','stock'].map(m=><button key={m} onClick={()=>setMode(m)} className={`flex-1 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all ${mode===m?'bg-blue-600 shadow-lg text-white':'text-slate-500'}`}><Icon name={m==='machine'?'Gamepad2':'Package'} size={18}/>{m==='machine'?'機台收入':'網上入貨'}</button>)}
                    </div>
                    {!readOnly && (
                        <div className="glass-card p-6 rounded-3xl space-y-4 border-t-2 border-t-blue-500/30">
                            <div className="hk-input-group"><input type="date" value={form.date} onChange={e=>setForm({...form,date:e.target.value})} className="hk-input"/></div>
                            {mode==='machine'?(<>
                                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">{settings.venues.map(v=><button key={v} onClick={()=>setForm({...form,venue:v})} className={`px-4 py-2 rounded-xl text-xs font-bold transition-all border ${form.venue===v?'bg-blue-600 border-blue-500 text-white shadow-md':'border-slate-700 text-slate-400 hover:bg-slate-800'}`}>{v}</button>)}</div>
                                <div className="grid grid-cols-2 gap-3"><button onClick={()=>setForm({...form,mType:'std'})} className={`py-3 rounded-xl text-xs font-bold border ${form.mType==='std'?'bg-blue-500/20 border-blue-500 text-blue-400':'border-slate-700 text-slate-500'}`}>標準機</button><button onClick={()=>setForm({...form,mType:'mini'})} className={`py-3 rounded-xl text-xs font-bold border ${form.mType==='mini'?'bg-pink-500/20 border-pink-500 text-pink-400':'border-slate-700 text-slate-500'}`}>迷你機</button></div>
                                {form.mType==='std'?<div className="hk-input-group border-green-500/30"><input type="number" placeholder="金額 $" value={form.amt} onChange={e=>setForm({...form,amt:e.target.value})} className="hk-input text-xl font-mono-num font-bold text-green-400"/></div>:<div className="flex gap-3"><div className="hk-input-group"><input type="number" placeholder="上層" value={form.top} onChange={e=>setForm({...form,top:e.target.value})} className="hk-input font-mono-num"/></div><div className="hk-input-group"><input type="number" placeholder="下層" value={form.bot} onChange={e=>setForm({...form,bot:e.target.value})} className="hk-input font-mono-num"/></div></div>}
                                <div className="hk-input-group"><input placeholder="備註..." value={form.note} onChange={e=>setForm({...form,note:e.target.value})} className="hk-input"/></div>
                            </>):(<>
                                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-1">{settings.sources.map(s=><button key={s} onClick={()=>setForm({...form,source:s})} className={`px-4 py-2 rounded-xl text-xs font-bold border ${form.source===s?'bg-purple-600 border-purple-500 text-white':'border-slate-700 text-slate-400'}`}>{s}</button>)}</div>
                                <div className="hk-input-group"><input placeholder="貨品名稱" value={form.item} onChange={e=>setForm({...form,item:e.target.value})} className="hk-input"/></div>
                                <div className="flex gap-3"><div className="hk-input-group"><input type="number" placeholder="數量" value={form.qty} onChange={e=>setForm({...form,qty:e.target.value})} className="hk-input font-mono-num"/></div><div className="hk-input-group border-red-500/30"><input type="number" placeholder="總成本 $" value={form.cost} onChange={e=>setForm({...form,cost:e.target.value})} className="hk-input text-red-400 font-bold font-mono-num"/></div></div>
                            </>)}
                            <button onClick={submit} className="w-full py-4 bg-white text-black font-black rounded-2xl shadow-[0_0_20px_rgba(255,255,255,0.3)] hover:scale-[1.02] transition-transform flex items-center justify-center gap-2"><Icon name="Save" size={18}/> 儲存記錄</button>
                        </div>
                    )}
                    <div className="space-y-3 pb-6">
                        <div className="text-xs font-bold text-slate-500 ml-2 tracking-widest">RECENT ACTIVITY</div>
                        {records.slice(0,5).map(r=>(<div key={r.id} onClick={()=>!readOnly && onEdit(r)} className="glass-card p-4 rounded-2xl flex items-center justify-between cursor-pointer hover:bg-white/5 border-l-4 border-l-transparent hover:border-l-blue-500"><div className="flex items-center gap-4"><div className={`p-2 rounded-xl ${r.type==='stock'?'bg-red-500/20 text-red-400':'bg-emerald-500/20 text-emerald-400'}`}><Icon name={r.type==='stock'?'Package':'Gamepad2'} size={20}/></div><div><div className="font-bold text-sm">{r.venue||r.itemName}</div><div className="text-[10px] text-slate-400">{r.date}</div></div></div><div className={`font-mono-num font-bold text-lg ${r.type==='stock'?'text-red-400':'text-green-400'}`}>{r.type==='stock'?'-':'+'}${r.amount}</div></div>))}
                    </div>
                </div>
            );
        };

        const DataFolder = ({ records, onEdit }) => {
            const [viewYear, setViewYear] = useState(null);
            const [viewMonth, setViewMonth] = useState(null);
            const tree = useMemo(() => { const t={}; records.filter(r=>['machine','stock'].includes(r.type)).forEach(r=>{const[y,m]=r.date.split('-'); if(!t[y])t[y]={total:0,months:{}}; if(!t[y].months[m])t[y].months[m]={inc:0,exp:0,items:[]}; const v=Number(r.amount); if(r.type==='machine'){t[y].total+=v;t[y].months[m].inc+=v;}else{t[y].total-=v;t[y].months[m].exp+=v;} t[y].months[m].items.push(r);}); return t;},[records]);

            if(viewMonth && viewYear) {
                const md = tree[viewYear]?.months[viewMonth] || {items:[]};
                return (<div className="space-y-4"><button onClick={()=>setViewMonth(null)} className="text-xs font-bold text-slate-400 mb-2 flex items-center gap-1 hover:text-white"><Icon name="ArrowLeft" size={14}/> BACK TO MONTHS</button><h2 className="text-2xl font-bold text-blue-400 flex items-center gap-2"><Icon name="FolderOpen"/> {viewYear} / {viewMonth}</h2><div className="space-y-3 pb-20">{md.items.map(r=>(<div key={r.id} onClick={()=>{if(onEdit) onEdit(r)}} className="glass-card p-4 rounded-xl flex justify-between items-center cursor-pointer border-l-2 border-slate-600 hover:border-blue-500"><div><div className="font-bold text-sm">{r.venue||r.itemName}</div><div className="text-[10px] text-slate-400">{r.date}</div></div><div className={`font-mono-num font-bold ${r.type==='stock'?'text-red-400':'text-green-400'}`}>${r.amount}</div></div>))}</div></div>);
            }
            if(viewYear) {
                return (<div className="space-y-4"><button onClick={()=>setViewYear(null)} className="text-xs font-bold text-slate-400 mb-2 flex items-center gap-1 hover:text-white"><Icon name="ArrowLeft" size={14}/> BACK TO YEARS</button><h2 className="text-2xl font-bold text-white flex items-center gap-2"><Icon name="Archive"/> {viewYear}</h2><div className="grid grid-cols-2 gap-4">{Object.keys(tree[viewYear].months).sort((a,b)=>b-a).map(m=><button key={m} onClick={()=>setViewMonth(m)} className="glass-card p-5 rounded-2xl text-left hover:bg-white/5 transition-all"><Icon name="Folder" className="text-yellow-500 mb-2"/><div className="font-bold text-xl">{m}月</div><div className="text-xs font-mono-num text-emerald-400 mt-1">NET: ${tree[viewYear].months[m].inc-tree[viewYear].months[m].exp}</div></button>)}</div></div>);
            }
            return (<div className="space-y-6"><h2 className="text-2xl font-bold flex gap-2 text-white"><Icon name="Database" className="text-blue-500"/> 資料庫存檔</h2><div className="grid grid-cols-1 gap-4">{Object.keys(tree).sort((a,b)=>b-a).map(y=><button key={y} onClick={()=>setViewYear(y)} className="glass-card p-6 rounded-3xl flex justify-between items-center hover:bg-white/5"><div className="flex items-center gap-4"><div className="p-3 bg-blue-900/30 rounded-xl border border-blue-500/30"><Icon name="FolderArchive" className="text-blue-400" size={28}/></div><div className="text-left"><div className="font-bold text-2xl text-white">{y}</div><div className="text-xs text-slate-400 uppercase">Fiscal Year</div></div></div><div className="font-mono-num font-bold text-emerald-400 text-xl">${tree[y].total}</div></button>)}</div></div>);
        };

        const VideoPage = ({ records, onAdd, onEdit, readOnly }) => {
            const [title, setTitle] = useState('');
            return (<div className="space-y-6"><div className="glass-card p-6 rounded-3xl bg-gradient-to-r from-purple-900/40 to-slate-900 border border-purple-500/20"><div className="flex items-center gap-4 mb-4"><div className="p-3 bg-purple-600 rounded-xl shadow-[0_0_20px_rgba(147,51,234,0.4)]"><Icon name="Clapperboard" className="text-white" size={28}/></div><div><h2 className="font-bold text-lg text-white">影片獎勵 Video</h2><p className="text-xs text-purple-300">Upload Bonus +$25</p></div></div>{!readOnly && <div className="flex gap-2"><div className="hk-input-group flex-1"><input value={title} onChange={e=>setTitle(e.target.value)} placeholder="影片標題 Title" className="hk-input"/></div><button onClick={()=>{if(title){onAdd({type:'video',title,date:new Date().toISOString().split('T')[0],amount:25});setTitle('')}}} className="bg-purple-600 px-5 rounded-xl text-white shadow-lg"><Icon name="Plus"/></button></div>}</div><div className="grid gap-3">{records.filter(r=>r.type==='video').map(r=><div key={r.id} onClick={()=>!readOnly && onEdit(r)} className="glass-card p-4 rounded-xl flex justify-between items-center border-l-4 border-purple-500 hover:bg-white/5 cursor-pointer"><div className="flex items-center gap-3"><Icon name="PlayCircle" className="text-purple-400" size={24}/><div><div className="font-bold text-sm text-white">{r.title}</div><div className="text-[10px] text-slate-500">{r.date}</div></div></div><span className="text-purple-400 font-bold font-mono-num">+$25</span></div>)}</div></div>);
        };

        const ClockPage = ({ records, onAdd, onEdit, user, readOnly }) => {
            const [now, setNow] = useState(new Date()); 
            const [start, setStart] = useState(null);
            
            useEffect(() => {
                const t = setInterval(() => setNow(new Date()), 1000); 
                const s = localStorage.getItem('clock_start'); 
                if (s) setStart(new Date(s)); 
                return () => clearInterval(t);
            }, []);

            const toggle = () => {
                if (readOnly) return; 
                if (!start) {
                    const d = new Date();
                    setStart(d);
                    localStorage.setItem('clock_start', d.toISOString());
                } else {
                    const end = new Date();
                    const diffHrs = (end - start) / 3600000;
                    const fullHrs = Math.floor(diffHrs);
                    const mins = (diffHrs - fullHrs) * 60;
                    
                    let pay = fullHrs * 50;
                    if (mins >= 45) pay += 50;
                    else if (mins >= 30) pay += 25;
                    
                    if (confirm(`時長: ${diffHrs.toFixed(2)}h\n薪金: $${pay}\n確認打卡?`)) {
                        onAdd({
                            type: 'clockin',
                            date: end.toISOString().split('T')[0],
                            amount: pay,
                            notes: `${diffHrs.toFixed(2)}h`
                        });
                        setStart(null);
                        localStorage.removeItem('clock_start');
                    }
                }
            };

            return (
                <div className="flex flex-col items-center py-8">
                    <div className="relative w-72 h-72 flex items-center justify-center mb-10">
                        <div className="absolute inset-0 rounded-full border-2 border-slate-800"></div>
                        <div className={`absolute inset-0 rounded-full border-t-2 border-r-2 ${start ? 'border-green-500 animate-spin shadow-[0_0_30px_#10b981]' : 'border-blue-500 animate-[spin_10s_linear_infinite]'}`}></div>
                        <div className="absolute inset-4 rounded-full border border-white/5 bg-slate-900/50 backdrop-blur-md flex flex-col items-center justify-center">
                            <div className="text-5xl font-black font-mono-num text-white tracking-widest">{now.toLocaleTimeString([], { hour12: false })}</div>
                            <div className="text-blue-400 font-bold mt-2">{now.toLocaleDateString()}</div>
                            {start && <div className="text-green-400 font-bold animate-pulse mt-2 tracking-[0.2em] text-glow-green">ON DUTY</div>}
                        </div>
                    </div>
                    {!readOnly && (
                        <button onClick={toggle} className={`w-full max-w-xs py-5 rounded-2xl font-black text-xl tracking-widest shadow-2xl flex items-center justify-center gap-3 transition-transform active:scale-95 ${start ? 'bg-gradient-to-r from-red-600 to-rose-500 shadow-[0_0_30px_rgba(220,38,38,0.4)]' : 'bg-gradient-to-r from-blue-600 to-cyan-500 shadow-[0_0_30px_rgba(37,99,235,0.4)]'}`}>
                            <Icon name="Zap" className={start ? "" : "animate-pulse"}/>
                            {start ? 'CLOCK OUT' : 'CLOCK IN'}
                        </button>
                    )}
                    <div className="mt-8 w-full space-y-2">
                        {records.filter(r => r.type === 'clockin').slice(0, 3).map(r => (
                            <div key={r.id} onClick={() => { if (!readOnly) onEdit(r); }} className="glass-card p-3 rounded-xl flex justify-between text-xs border-l-2 border-yellow-500 cursor-pointer hover:bg-white/5">
                                <span className="text-slate-400">{r.date}</span>
                                <span className="text-white">{r.notes}</span>
                                <span className="text-yellow-400 font-bold font-mono-num">${r.amount}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const Summary = ({records}) => {
            const s=records.reduce((a,r)=>{const v=Number(r.amount);if(r.type==='machine')a.m+=v;else if(r.type==='video')a.v+=v;else if(r.type==='clockin')a.c+=v;else if(r.type==='stock')a.s+=v;return a;},{m:0,v:0,c:0,s:0});
            const t=s.m+s.v+s.c-s.s;
            return (<div className="space-y-6 pt-4"><div className="glass-card p-8 rounded-3xl text-center relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div><div className="text-xs text-slate-400 uppercase tracking-[0.2em] mb-2">Net Surplus</div><div className={`text-6xl font-black font-mono-num ${t>=0?'text-emerald-400 text-glow-green':'text-red-400 text-glow-red'}`}>${t.toLocaleString()}</div></div><div className="grid grid-cols-2 gap-3"><CardStat label="Machine" value={s.m.toLocaleString()} type="green"/><CardStat label="Stock" value={s.s.toLocaleString()} type="red"/><CardStat label="Clock" value={s.c.toLocaleString()} type="yellow"/><CardStat label="Video" value={s.v.toLocaleString()} type="blue"/></div></div>);
        };

        const SettingsPage = ({user, settings, onUpdate, logout, readOnly}) => {
            if(readOnly) return <div className="text-center p-10 text-slate-500">唯讀模式 (Read Only)</div>;
            const [newVenue, setNewVenue] = useState(''); const [newSource, setNewSource] = useState('');
            const add = (k,v) => { if(v){onUpdate({...settings,[k]:[...settings[k],v]}); k==='venues'?setNewVenue(''):setNewSource('');} };
            const del = (k,v) => { if(confirm('Del?')) onUpdate({...settings,[k]:settings[k].filter(x=>x!==v)}); };

            return (
                <div className="space-y-6 pb-20">
                    <div className="glass-card p-6 rounded-3xl flex items-center gap-4 border border-white/5"><div className="w-16 h-16 rounded-full bg-gradient-to-tr from-blue-600 to-purple-600 flex items-center justify-center font-bold text-2xl shadow-lg">{user.displayName[0]}</div><div><div className="font-bold text-xl text-white">{user.displayName}</div><div className="text-xs text-slate-400">{user.email}</div></div></div>
                    <div className="glass-card p-6 rounded-3xl space-y-4"><h3 className="font-bold text-slate-300 flex items-center gap-2"><Icon name="UserCog" size={18}/> 暱稱</h3><div className="hk-input-group"><input value={settings.nickname} onChange={e=>onUpdate({...settings,nickname:e.target.value})} className="hk-input"/></div></div>
                    
                    <div className="glass-card p-6 rounded-3xl space-y-4"><h3 className="font-bold text-slate-300 flex items-center gap-2"><Icon name="MapPin" size={18}/> 場地 Venues</h3><div className="flex flex-wrap gap-2">{settings.venues.map(v=><span key={v} className="px-3 py-1 bg-blue-900/30 rounded-lg text-xs flex items-center gap-2 border border-blue-500/30 text-blue-200">{v}<button onClick={()=>del('venues',v)}><Icon name="X" size={10}/></button></span>)}</div><div className="flex gap-2"><div className="hk-input-group flex-1"><input value={newVenue} onChange={e=>setNewVenue(e.target.value)} placeholder="新場地" className="hk-input text-sm py-2"/></div><button onClick={()=>add('venues',newVenue)} className="px-4 bg-blue-600 rounded-xl"><Icon name="Plus"/></button></div></div>
                    
                    <div className="glass-card p-6 rounded-3xl space-y-4"><h3 className="font-bold text-slate-300 flex items-center gap-2"><Icon name="Truck" size={18}/> 來源 Sources</h3><div className="flex flex-wrap gap-2">{settings.sources.map(s=><span key={s} className="px-3 py-1 bg-purple-900/30 rounded-lg text-xs flex items-center gap-2 border border-purple-500/30 text-purple-200">{s}<button onClick={()=>del('sources',s)}><Icon name="X" size={10}/></button></span>)}</div><div className="flex gap-2"><div className="hk-input-group flex-1"><input value={newSource} onChange={e=>setNewSource(e.target.value)} placeholder="新來源" className="hk-input text-sm py-2"/></div><button onClick={()=>add('sources',newSource)} className="px-4 bg-purple-600 rounded-xl"><Icon name="Plus"/></button></div></div>

                    <button onClick={logout} className="w-full py-4 rounded-2xl bg-red-500/10 text-red-400 border border-red-500/20 font-bold hover:bg-red-500/20 transition-colors">登出系統</button>
                </div>
            );
        };

        // --- Login ---
        const Login = ({ onLogin }) => {
            const [email, setEmail] = useState(''); const [pass, setPass] = useState('');
            const authAct = async (t) => { try { if(t==='g') await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); else if(t==='guest') {localStorage.setItem('guest',JSON.stringify({uid:'guest',displayName:'Guest',isGuest:true})); onLogin({uid:'guest',displayName:'Guest',isGuest:true});} else await auth.signInWithEmailAndPassword(email,pass); } catch(e){alert(e.message);} };
            return (
                <div className="min-h-screen flex items-center justify-center p-6 z-50 relative">
                    <div className="glass-card p-10 rounded-[40px] w-full max-w-sm border border-white/10 shadow-2xl backdrop-blur-xl">
                        <div className="text-center mb-10">
                            <div className="w-20 h-20 bg-gradient-to-tr from-blue-600 to-purple-600 rounded-2xl mx-auto mb-6 flex items-center justify-center shadow-[0_0_40px_rgba(37,99,235,0.5)] transform rotate-3"><Icon name="Gamepad2" size={40} className="text-white"/></div>
                            <h1 className="text-4xl font-black italic tracking-tighter text-white">MACHINE<span className="text-blue-500">PRO</span></h1>
                            <p className="text-slate-500 text-xs tracking-[0.4em] uppercase mt-2">Hong Kong Edition</p>
                        </div>
                        <div className="space-y-4">
                            <button onClick={()=>authAct('g')} className="w-full py-4 bg-white text-black font-bold rounded-2xl flex justify-center items-center gap-3 hover:scale-105 transition-transform shadow-lg">
                                <svg viewBox="0 0 24 24" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Google Login
                            </button>
                            <div className="flex items-center gap-2 text-xs text-slate-600 py-2"><div className="h-px bg-slate-800 flex-1"></div>OR<div className="h-px bg-slate-800 flex-1"></div></div>
                            <div className="hk-input-group"><input placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} className="hk-input"/></div>
                            <div className="hk-input-group"><input type="password" placeholder="Password" value={pass} onChange={e=>setPass(e.target.value)} className="hk-input"/></div>
                            <button onClick={()=>authAct('e')} className="w-full py-4 bg-blue-600 font-bold rounded-2xl shadow-[0_0_20px_rgba(37,99,235,0.4)] text-white hover:bg-blue-500 transition-colors">Login / Register</button>
                            <button onClick={()=>authAct('guest')} className="text-slate-500 w-full text-center text-xs hover:text-white transition-colors">訪客試用 Guest Mode</button>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>