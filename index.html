<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>機台收支管理系統 V13.0</title>
    
    <!-- React & Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&family=JetBrains+Mono:wght@400;700&display=swap');
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #000000;
            color: #ffffff;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
            overscroll-behavior-y: none;
        }

        /* --- 極光動態背景 --- */
        .aurora-bg {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.2), transparent 50%),
                        radial-gradient(circle at 100% 100%, rgba(139, 92, 246, 0.2), transparent 50%),
                        radial-gradient(circle at 50% 50%, rgba(16, 185, 129, 0.05), transparent 50%);
            z-index: -2;
            animation: pulse-bg 10s ease-in-out infinite alternate;
        }
        @keyframes pulse-bg {
            0% { opacity: 0.8; transform: scale(1); }
            100% { opacity: 1; transform: scale(1.05); }
        }

        /* --- 雜訊質感 --- */
        .noise-overlay {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIj48ZmlsdGVyIGlkPSJub2lzZSI+PHBmZVR1cmJ1bGVuY2UgdHlwZT0iZnJhY3RhbE5vaXNlIiBiYXNlRnJlcXVlbmN5PSIwLjY1IiBudW1PY3RhdmVzPSIzIiBzdGl0Y2hUaWxlcz0ic3RpdGNoIi8+PC9maWx0ZXI+PHJlY3Qgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsdGVyPSJ1cmwoI25vaXNlKSIgb3BhY2l0eT0iMC4wNSIvPjwvc3ZnPg==');
            pointer-events: none;
            z-index: -1;
            opacity: 0.5;
        }

        /* --- 水晶玻璃組件 --- */
        .glass-panel {
            background: rgba(30, 30, 35, 0.65);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-top: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border-radius: 24px;
        }

        .glass-nav {
            background: rgba(20, 20, 20, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .glass-modal {
            background: rgba(20, 20, 25, 0.95);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 60px rgba(0,0,0,0.8);
        }

        /* --- 高質感輸入框 --- */
        .hk-input-group {
            position: relative;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 16px;
            padding: 2px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .hk-input-group:focus-within {
            border-color: #60a5fa;
            box-shadow: 0 0 20px rgba(96, 165, 250, 0.2);
            background: rgba(0, 0, 0, 0.6);
        }
        .hk-input {
            background: transparent;
            border: none;
            color: white;
            padding: 14px 16px;
            font-size: 1rem;
            width: 100%;
            outline: none;
        }
        
        .font-mono-num { font-family: 'JetBrains Mono', monospace; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .pt-safe-top { padding-top: env(safe-area-inset-top, 20px); }
        .pb-safe-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
    </style>
</head>
<body>
    <div class="aurora-bg"></div>
    <div class="noise-overlay"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, createContext, useContext } = React;
        const { motion, AnimatePresence } = window.Motion;

        // --- Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyBJ0qf4FyJ-Ln8uTlVfyqq84IAeUsTWSCo",
            authDomain: "recordmachine.firebaseapp.com",
            projectId: "recordmachine",
            storageBucket: "recordmachine.firebasestorage.app",
            messagingSenderId: "817708522720",
            appId: "1:817708522720:web:5e3b876ce170012d53c485",
            measurementId: "G-WR49R47LN1"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Icon ---
        const Icon = ({ name, size=20, className="", ...props }) => {
            const ref = useRef(null);
            useEffect(() => {
                if (window.lucide && ref.current && window.lucide.icons[name]) {
                    const svg = window.lucide.createElement(window.lucide.icons[name]);
                    svg.setAttribute('width', size);
                    svg.setAttribute('height', size);
                    svg.setAttribute('class', className);
                    ref.current.innerHTML = '';
                    ref.current.appendChild(svg);
                }
            }, [name, size, className]);
            return <span ref={ref} {...props} className={`inline-flex items-center justify-center ${className}`} />;
        };

        // --- Contexts ---
        const ToastContext = createContext();
        const ModalContext = createContext();

        // --- UI Provider ---
        const UIProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            const [modal, setModal] = useState(null);

            const addToast = (msg, type = 'success') => {
                const id = Date.now();
                setToasts(prev => [...prev, { id, msg, type }]);
                setTimeout(() => setToasts(prev => prev.filter(t => t.id !== id)), 3000);
            };

            return (
                <ToastContext.Provider value={addToast}>
                    <ModalContext.Provider value={setModal}>
                        {children}
                        <div className="fixed top-6 left-0 right-0 z-[100] flex flex-col items-center gap-2 pointer-events-none px-4 pt-safe-top">
                            <AnimatePresence>
                                {toasts.map(t => (
                                    <motion.div key={t.id} initial={{opacity:0,y:-20}} animate={{opacity:1,y:0}} exit={{opacity:0}} className={`glass-panel px-4 py-3 rounded-2xl flex items-center gap-3 shadow-2xl pointer-events-auto border-l-4 ${t.type==='error'?'border-red-500':'border-emerald-500'}`}>
                                        <Icon name={t.type==='error'?'AlertCircle':'CheckCircle2'} size={18} className={t.type==='error'?'text-red-400':'text-emerald-400'}/>
                                        <span className="font-bold text-sm text-white">{t.msg}</span>
                                    </motion.div>
                                ))}
                            </AnimatePresence>
                        </div>
                        <AnimatePresence>
                            {modal && (
                                <div className="fixed inset-0 z-[80] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                                    <motion.div initial={{opacity:0,scale:0.95}} animate={{opacity:1,scale:1}} exit={{opacity:0,scale:0.95}} className="w-full max-w-xs sm:max-w-sm">
                                        <div className="glass-modal rounded-3xl p-6 text-center border-white/10 border">
                                            <h3 className="text-xl font-bold text-white mb-2">{modal.props.title}</h3>
                                            <p className="text-slate-400 text-sm mb-6">{modal.props.message}</p>
                                            <div className="grid grid-cols-2 gap-3">
                                                <button onClick={()=>setModal(null)} className="py-3 rounded-xl bg-slate-800 text-slate-300 font-bold hover:bg-slate-700 transition-colors">取消</button>
                                                <button onClick={()=>{modal.props.onConfirm(); setModal(null);}} className="py-3 rounded-xl bg-red-600 text-white font-bold hover:bg-red-500 transition-colors shadow-lg shadow-red-900/30">確認</button>
                                            </div>
                                        </div>
                                    </motion.div>
                                </div>
                            )}
                        </AnimatePresence>
                    </ModalContext.Provider>
                </ToastContext.Provider>
            );
        };

        // --- Components ---
        const NavBar = ({ current, setView }) => {
            const tabs = [
                { id: 'accounting', label: '記數', icon: 'Calculator' }, 
                { id: 'data', label: '資料', icon: 'FolderOpen' }, 
                { id: 'video', label: '影片', icon: 'Film' }, 
                { id: 'clock', label: '打卡', icon: 'Timer' }, 
                { id: 'summary', label: '結算', icon: 'PieChart' }
            ];
            
            return (
                <div className="glass-nav mb-6 overflow-x-auto no-scrollbar rounded-2xl p-1">
                    {tabs.map((tab) => {
                        const active = current === tab.id;
                        return (
                            <button key={tab.id} onClick={() => setView(tab.id)} className={`relative flex flex-col items-center justify-center min-w-[64px] py-2 rounded-xl transition-all duration-300 ${active ? 'bg-blue-600/20 text-blue-400' : 'text-slate-500 hover:text-slate-300'}`}>
                                <Icon name={tab.icon} size={20} className={active ? "drop-shadow-lg" : ""} />
                                <span className="text-[10px] font-bold mt-1">{tab.label}</span>
                                {active && <motion.div layoutId="nav-pill" className="absolute bottom-1 w-1.5 h-1.5 bg-blue-500 rounded-full shadow-[0_0_10px_#3b82f6]" />}
                            </button>
                        );
                    })}
                </div>
            );
        };

        const TopBar = ({ user, viewingUser, monthlyEst, isOnline, switchViewUser, setShowShareModal, setView }) => {
            return (
                <div className="fixed top-0 inset-x-0 z-40 bg-black/60 backdrop-blur-xl border-b border-white/5 px-6 pt-safe-top pb-4 flex justify-between items-center h-auto min-h-[100px]">
                    <div className="flex flex-col w-1/3">
                        <div className="flex items-center gap-2 mb-1">
                            <div className="w-9 h-9 rounded-full bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center font-bold text-sm shadow-lg border border-white/10">
                                {viewingUser ? viewingUser.ownerEmail[0].toUpperCase() : user?.displayName?.[0]?.toUpperCase()}
                            </div>
                            <div className="flex flex-col overflow-hidden">
                                <span className="text-xs font-bold text-white leading-tight truncate w-24">
                                    {viewingUser ? viewingUser.ownerEmail : user?.displayName}
                                </span>
                                <span className="text-[9px] text-slate-400 truncate w-24">{user?.email}</span>
                            </div>
                        </div>
                        {viewingUser && <span className="text-[9px] font-bold text-purple-300 bg-purple-500/20 px-2 py-0.5 rounded-full w-fit border border-purple-500/30">VIEWING MODE</span>}
                    </div>
                    
                    <div className="flex flex-col items-center justify-center gap-2 w-1/3">
                        <div className="glass-panel px-3 py-1 rounded-full border border-white/10 bg-black/40 text-center w-full max-w-[140px] flex justify-between items-center shadow-lg">
                            <span className="text-[9px] text-slate-400 uppercase font-bold mr-2 tracking-wider">預收</span>
                            <span className="text-sm font-mono-num font-black text-emerald-400 drop-shadow-[0_0_8px_rgba(52,211,153,0.5)]">${monthlyEst.toLocaleString()}</span>
                        </div>
                         <div className="flex items-center gap-1.5 opacity-80">
                            <div className={`w-1.5 h-1.5 rounded-full ${isOnline ? 'bg-emerald-500 shadow-[0_0_5px_#10b981]' : 'bg-red-500'}`}></div>
                            <span className={`text-[9px] font-bold ${isOnline ? 'text-emerald-500' : 'text-red-500'}`}>{isOnline ? '連線中' : '離線'}</span>
                        </div>
                    </div>

                    <div className="flex items-center justify-end gap-3 w-1/3">
                        {viewingUser ? (
                            <button onClick={()=>switchViewUser(null)} className="p-2.5 rounded-2xl bg-red-500/10 text-red-400 border border-red-500/20 hover:bg-red-500/20 transition-all"><Icon name="LogOut" size={20}/></button>
                        ) : (
                            <>
                                <button onClick={()=>setView('settings')} className="p-2.5 rounded-2xl bg-slate-800/80 text-slate-300 border border-white/10 hover:bg-slate-700 transition-all"><Icon name="Settings" size={20}/></button>
                                <button onClick={()=>setShowShareModal(true)} className="p-2.5 rounded-2xl bg-blue-600 text-white shadow-lg shadow-blue-600/20 hover:bg-blue-500 transition-all"><Icon name="Share2" size={20}/></button>
                            </>
                        )}
                    </div>
                </div>
            );
        };

        const Accounting = ({ records, onAdd, onEdit, settings, readOnly, nav }) => {
            const [mode, setMode] = useState('machine');
            const [form, setForm] = useState({date: new Date().toISOString().split('T')[0], venue: '', mType: 'std', amt: '', top: '', bot: '', note: '', source: '', item: '', qty: '', cost: ''});
            const toast = useContext(ToastContext);
            const [isSaving, setIsSaving] = useState(false);
            
            useEffect(() => {
                if (settings.venues?.length && !form.venue) setForm(prev => ({...prev, venue: settings.venues[0]}));
                if (settings.sources?.length && !form.source) setForm(prev => ({...prev, source: settings.sources[0]}));
            }, [settings]);

            const submit = async () => {
                if(readOnly) return;
                setIsSaving(true);
                try {
                    if(mode==='machine') { 
                        const tot = form.mType==='std' ? Number(form.amt) : Number(form.top)+Number(form.bot);
                        if(!tot) throw new Error('請輸入金額');
                        await onAdd({type:'machine',...form,amount:tot,details:form.mType==='mini'?{top:form.top,bot:form.bot}:null}); 
                    } else { 
                        if(!form.cost) throw new Error('請輸入成本');
                        await onAdd({type:'stock',...form,amount:Number(form.cost)}); 
                    }
                    setForm(f => ({...f, amt:'', top:'', bot:'', cost:''})); 
                    toast('記錄已成功儲存');
                } catch (error) {
                    alert("儲存失敗: " + error.message);
                } finally {
                    setIsSaving(false);
                }
            };

            return (
                <div className="space-y-6 pb-24 px-6 animate-fade-in">
                    <div className="grid grid-cols-2 gap-4">
                        <button onClick={()=>setMode('machine')} className={`p-4 rounded-3xl border transition-all duration-300 flex flex-col items-center gap-2 ${mode==='machine' ? 'bg-blue-600 border-blue-500 shadow-xl shadow-blue-900/30' : 'glass-panel border-white/5 text-slate-500 hover:bg-white/5'}`}>
                            <Icon name="Gamepad2" size={32} className="text-white"/>
                            <span className="font-bold text-sm text-white tracking-wider">機台收入</span>
                        </button>
                        <button onClick={()=>setMode('stock')} className={`p-4 rounded-3xl border transition-all duration-300 flex flex-col items-center gap-2 ${mode==='stock' ? 'bg-purple-600 border-purple-500 shadow-xl shadow-purple-900/30' : 'glass-panel border-white/5 text-slate-500 hover:bg-white/5'}`}>
                            <Icon name="Package" size={32} className="text-white"/>
                            <span className="font-bold text-sm text-white tracking-wider">網上入貨</span>
                        </button>
                    </div>

                    {/* Navigation Sandwich */}
                    {nav}

                    {!readOnly && (
                        <div className="glass-panel p-6 rounded-[32px] space-y-5 border-t-2 border-t-blue-500/20 relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-50"></div>
                            
                            <div className="hk-input-group"><input type="date" value={form.date} onChange={e=>setForm({...form,date:e.target.value})} className="hk-input text-lg font-bold text-center tracking-widest"/></div>
                            
                            {mode==='machine'?(<>
                                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">{(settings.venues || []).map(v=><button key={v} onClick={()=>setForm({...form,venue:v})} className={`px-4 py-2 rounded-xl text-xs font-bold border transition-all ${form.venue===v?'bg-blue-600 border-blue-500 text-white shadow-lg':'border-slate-700 text-slate-400 hover:bg-slate-800'}`}>{v}</button>)}</div>
                                <div className="flex bg-black/30 p-1.5 rounded-2xl"><button onClick={()=>setForm({...form,mType:'std'})} className={`flex-1 py-2.5 rounded-xl text-xs font-bold transition-all ${form.mType==='std'?'bg-slate-700 text-white shadow':'text-slate-500'}`}>標準機</button><button onClick={()=>setForm({...form,mType:'mini'})} className={`flex-1 py-2.5 rounded-xl text-xs font-bold transition-all ${form.mType==='mini'?'bg-slate-700 text-white shadow':'text-slate-500'}`}>迷你機</button></div>
                                {form.mType==='std'?<div className="hk-input-group border-green-500/30"><input type="number" placeholder="收入金額 $" value={form.amt} onChange={e=>setForm({...form,amt:e.target.value})} className="hk-input text-2xl font-mono-num font-bold text-emerald-400 text-center"/></div>:<div className="flex gap-3"><div className="hk-input-group"><input type="number" placeholder="上層 $" value={form.top} onChange={e=>setForm({...form,top:e.target.value})} className="hk-input font-mono-num text-center"/></div><div className="hk-input-group"><input type="number" placeholder="下層 $" value={form.bot} onChange={e=>setForm({...form,bot:e.target.value})} className="hk-input font-mono-num text-center"/></div></div>}
                                <div className="hk-input-group"><input placeholder="備註..." value={form.note} onChange={e=>setForm({...form,note:e.target.value})} className="hk-input"/></div>
                            </>):(<>
                                <div className="flex gap-2 overflow-x-auto no-scrollbar pb-2">{(settings.sources || []).map(s=><button key={s} onClick={()=>setForm({...form,source:s})} className={`px-4 py-2 rounded-xl text-xs font-bold border transition-all ${form.source===s?'bg-purple-600 border-purple-500 text-white shadow-lg':'border-slate-700 text-slate-400 hover:bg-slate-800'}`}>{s}</button>)}</div>
                                <div className="hk-input-group"><input placeholder="貨品名稱" value={form.item} onChange={e=>setForm({...form,item:e.target.value})} className="hk-input"/></div>
                                <div className="flex gap-3"><div className="hk-input-group w-1/3"><input type="number" placeholder="數量" value={form.qty} onChange={e=>setForm({...form,qty:e.target.value})} className="hk-input font-mono-num text-center"/></div><div className="hk-input-group flex-1 border-red-500/30"><input type="number" placeholder="總成本 $" value={form.cost} onChange={e=>setForm({...form,cost:e.target.value})} className="hk-input text-xl text-red-400 font-bold font-mono-num text-center"/></div></div>
                            </>)}
                            <button onClick={submit} disabled={isSaving} className={`w-full py-4 rounded-2xl shadow-lg flex items-center justify-center gap-3 text-sm font-bold transition-all active:scale-95 ${isSaving ? 'bg-slate-700 text-slate-400' : 'bg-white text-black hover:bg-gray-100'}`}>
                                {isSaving ? <Icon name="Loader2" className="animate-spin"/> : <Icon name="Save" size={20}/>}
                                {isSaving ? '儲存中...' : '儲存記錄 SAVE'}
                            </button>
                        </div>
                    )}

                    <div className="space-y-4">
                        <div className="flex items-center gap-2 mb-2 px-2">
                            <div className="w-1 h-4 bg-blue-500 rounded-full"></div>
                            <span className="text-xs font-bold text-slate-400 tracking-widest uppercase">RECENT ACTIVITY</span>
                        </div>
                        {(records || []).slice(0, 10).map(r => (
                            <div key={r.id} onClick={()=>!readOnly && onEdit(r)} className="glass-panel p-4 rounded-2xl flex justify-between items-center cursor-pointer hover:bg-white/5 border-l-4 border-l-transparent hover:border-l-blue-500 transition-all">
                                <div className="flex items-center gap-4">
                                    <div className={`p-3 rounded-xl shadow-lg ${r.type==='stock'?'bg-red-500/10 text-red-400':'bg-emerald-500/10 text-emerald-400'}`}>
                                        <Icon name={r.type==='stock'?'Package':r.type==='video'?'Film':r.type==='clockin'?'Timer':'Gamepad2'} size={20}/>
                                    </div>
                                    <div>
                                        <div className="font-bold text-sm text-white mb-0.5">{r.venue || r.itemName || r.title || '打卡'}</div>
                                        <div className="text-[10px] text-slate-500 font-mono-num">{r.date}</div>
                                    </div>
                                </div>
                                <div className={`font-mono-num font-bold text-lg ${r.type==='stock'?'text-red-400 drop-shadow-[0_0_8px_rgba(248,113,113,0.3)]':'text-emerald-400 drop-shadow-[0_0_8px_rgba(52,211,153,0.3)]'}`}>
                                    {r.type==='stock'?'-':'+'}${r.amount}
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        // --- Other Components (Kept same as stable V11.1 but integrated) ---
        // DataFolder, VideoPage, ClockPage, Summary, SettingsPage, Login, ShareCenter, EditModal
        // I will copy them ensuring no syntax errors.

        const DataFolder = ({ records, onEdit }) => {
            const [viewYear, setViewYear] = useState(null);
            const [viewMonth, setViewMonth] = useState(null);
            const tree = useMemo(() => { const t={}; (records||[]).filter(r=>['machine','stock'].includes(r.type)).forEach(r=>{const[y,m]=r.date.split('-'); if(!t[y])t[y]={total:0,months:{}}; if(!t[y].months[m])t[y].months[m]={inc:0,exp:0,items:[]}; const v=Number(r.amount); if(r.type==='machine'){t[y].total+=v;t[y].months[m].inc+=v;}else{t[y].total-=v;t[y].months[m].exp+=v;} t[y].months[m].items.push(r);}); return t;},[records]);

            if(viewMonth && viewYear) {
                const md = tree[viewYear]?.months[viewMonth] || {items:[]};
                return (<div className="space-y-4 px-6 pt-6"><button onClick={()=>setViewMonth(null)} className="text-xs font-bold text-slate-400 mb-2 flex items-center gap-1 hover:text-white"><Icon name="ArrowLeft" size={14}/> Back</button><h2 className="text-lg font-bold text-blue-400 flex items-center gap-2 mb-4"><Icon name="FolderOpen" size={18}/> {viewYear} / {viewMonth}</h2><div className="space-y-3 pb-24">{md.items.map(r=>(<div key={r.id} onClick={()=>{if(onEdit) onEdit(r)}} className="glass-panel p-4 rounded-2xl flex justify-between items-center cursor-pointer border-l-2 border-slate-600 hover:border-blue-500"><div><div className="font-bold text-sm">{r.venue||r.itemName}</div><div className="text-[10px] text-slate-400">{r.date}</div></div><div className={`font-mono-num font-bold text-sm ${r.type==='stock'?'text-red-400':'text-emerald-400'}`}>${r.amount}</div></div>))}</div></div>);
            }
            if(viewYear) {
                return (<div className="space-y-4 px-6 pt-6"><button onClick={()=>setViewYear(null)} className="text-xs font-bold text-slate-400 mb-2 flex items-center gap-1 hover:text-white"><Icon name="ArrowLeft" size={14}/> Back</button><h2 className="text-lg font-bold text-white flex items-center gap-2 mb-4"><Icon name="Archive" size={18}/> {viewYear}</h2><div className="grid grid-cols-2 gap-3">{Object.keys(tree[viewYear].months).sort((a,b)=>b-a).map(m=><button key={m} onClick={()=>setViewMonth(m)} className="glass-panel p-4 rounded-2xl text-left hover:bg-white/5 transition-all"><Icon name="Folder" className="text-yellow-500 mb-2" size={24}/><div className="font-bold text-sm">{m}月</div><div className="text-[10px] font-mono-num text-emerald-400 mt-1">NET: ${tree[viewYear].months[m].inc-tree[viewYear].months[m].exp}</div></button>)}</div></div>);
            }
            return (<div className="space-y-4 px-6 pt-6"><h2 className="text-lg font-bold flex gap-2 text-white mb-4"><Icon name="Database" className="text-blue-500" size={18}/> 存檔</h2><div className="grid grid-cols-1 gap-3">{Object.keys(tree).sort((a,b)=>b-a).map(y=><button key={y} onClick={()=>setViewYear(y)} className="glass-panel p-5 rounded-2xl flex justify-between items-center hover:bg-white/5"><div className="flex items-center gap-3"><div className="p-2 bg-blue-900/30 rounded-lg border border-blue-500/30"><Icon name="FolderArchive" className="text-blue-400" size={20}/></div><div className="text-left"><div className="font-bold text-lg text-white">{y}</div><div className="text-[10px] text-slate-400 uppercase">Yearly Total</div></div></div><div className="font-mono-num font-bold text-emerald-400 text-lg">${tree[y].total}</div></button>)}</div></div>);
        };

        const VideoPage = ({ records, onAdd }) => {
            const [title, setTitle] = useState(''); const toast = useContext(ToastContext);
            return (<div className="space-y-4 px-6 pt-6 pb-24"><div className="glass-panel p-5 rounded-3xl bg-gradient-to-r from-purple-900/40 to-slate-900 border border-purple-500/20"><div className="flex items-center gap-4 mb-4"><div className="p-3 bg-purple-600 rounded-xl shadow-[0_0_20px_rgba(147,51,234,0.4)]"><Icon name="Clapperboard" className="text-white" size={24}/></div><div><h2 className="font-bold text-lg text-white">影片獎勵</h2><p className="text-[10px] text-purple-300">每條 +$25</p></div></div><div className="flex gap-2"><div className="hk-input-group flex-1"><input value={title} onChange={e=>setTitle(e.target.value)} placeholder="影片標題 Title" className="hk-input text-sm"/></div><button onClick={()=>{if(title){onAdd({type:'video',title,date:new Date().toISOString().split('T')[0],amount:25});setTitle(''); toast('已新增');}}} className="bg-purple-600 px-4 rounded-xl text-white shadow-lg"><Icon name="Plus" size={18}/></button></div></div><div className="grid gap-2">{(records||[]).filter(r=>r.type==='video').map(r=><div key={r.id} className="glass-panel p-3 rounded-xl flex justify-between items-center border-l-2 border-purple-500"><div className="flex items-center gap-3"><Icon name="PlayCircle" className="text-purple-400" size={18}/><div><div className="font-bold text-xs text-white">{r.title}</div><div className="text-[9px] text-slate-500">{r.date}</div></div></div><span className="text-purple-400 font-bold font-mono-num text-sm">+$25</span></div>)}</div></div>);
        };

        const ClockPage = ({ records, onAdd, user }) => {
            const [now, setNow] = useState(new Date()); const [start, setStart] = useState(null); const setModal = useContext(ModalContext); const toast = useContext(ToastContext);
            useEffect(() => { const t = setInterval(() => setNow(new Date()), 1000); const s = localStorage.getItem('clock_start'); if (s) setStart(new Date(s)); return () => clearInterval(t); }, []);
            const toggle = () => { if (!start) { const d = new Date(); setStart(d); localStorage.setItem('clock_start', d.toISOString()); toast('已上班打卡'); } else { const end = new Date(); const diffHrs = (end - start) / 3600000; const fullHrs = Math.floor(diffHrs); const mins = (diffHrs - fullHrs) * 60; let pay = fullHrs * 50; if (mins >= 45) pay += 50; else if (mins >= 30) pay += 25; setModal({ type: 'clockout', props: { hours: diffHrs.toFixed(2), range: `${start.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})} - ${end.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}`, pay: pay, onConfirm: () => { onAdd({ type: 'clockin', date: end.toISOString().split('T')[0], amount: pay, notes: `${diffHrs.toFixed(2)}h` }); setStart(null); localStorage.removeItem('clock_start'); toast('已下班結算'); } } }); } };
            return (<div className="flex flex-col items-center py-6 px-6 pt-10"><div className="relative w-72 h-72 flex items-center justify-center mb-10"><div className="absolute inset-0 rounded-full border-2 border-slate-800"></div><div className={`absolute inset-0 rounded-full border-t-2 border-r-2 ${start ? 'border-green-500 animate-spin shadow-[0_0_30px_#10b981]' : 'border-blue-500 animate-[spin_10s_linear_infinite]'}`}></div><div className="absolute inset-4 rounded-full border border-white/5 bg-slate-900/50 backdrop-blur-md flex flex-col items-center justify-center"><div className="text-4xl font-black font-mono-num text-white tracking-widest">{now.toLocaleTimeString([], { hour12: false })}</div><div className="text-blue-400 font-bold mt-2 text-sm">{now.toLocaleDateString()}</div>{start && <div className="text-green-400 font-bold animate-pulse mt-2 tracking-[0.2em] text-glow-green text-xs">ON DUTY</div>}</div></div><button onClick={toggle} className={`w-full max-w-xs py-4 rounded-2xl font-black text-lg tracking-widest shadow-2xl flex items-center justify-center gap-3 active:scale-95 transition-transform ${start ? 'bg-gradient-to-r from-red-600 to-rose-500' : 'bg-gradient-to-r from-blue-600 to-cyan-500'}`}><Icon name="Zap" className={start ? "" : "animate-pulse"}/>{start ? 'CLOCK OUT' : 'CLOCK IN'}</button><div className="mt-8 w-full space-y-2 pb-24">{(records||[]).filter(r => r.type === 'clockin').slice(0, 3).map(r => (<div key={r.id} className="glass-panel p-3 rounded-xl flex justify-between text-xs border-l-2 border-yellow-500"><span className="text-slate-400">{r.date}</span><span className="text-white">{r.notes}</span><span className="text-yellow-400 font-bold font-mono-num">${r.amount}</span></div>))}</div></div>);
        };

        const Summary = ({records}) => {
            const [filter, setFilter] = useState(null);
            const s=(records||[]).reduce((a,r)=>{const v=Number(r.amount);if(r.type==='machine')a.m+=v;else if(r.type==='video')a.v+=v;else if(r.type==='clockin')a.c+=v;else if(r.type==='stock')a.s+=v;return a;},{m:0,v:0,c:0,s:0});
            const t=s.m+s.v+s.c-s.s;
            const DetailList = ({ type }) => { const list = records.filter(r => r.type === type); return (<div className="glass-panel p-4 rounded-2xl mt-4 border border-white/10 bg-black/40"><div className="flex justify-between items-center mb-2"><h3 className="font-bold text-sm uppercase text-slate-300">{type} 詳細列表</h3><button onClick={() => setFilter(null)} className="p-1 rounded-full hover:bg-white/10"><Icon name="X" size={16}/></button></div><div className="space-y-2 max-h-60 overflow-y-auto no-scrollbar">{list.map(r => (<div key={r.id} className="flex justify-between text-xs p-2 rounded bg-white/5"><span>{r.date} - {r.venue || r.itemName || r.title || '打卡'}</span><span className="font-mono-num text-green-400">${r.amount}</span></div>))}</div></div>); };
            return (<div className="space-y-4 px-6 pt-6 pb-24"><div className="glass-panel p-6 rounded-3xl text-center relative overflow-hidden"><div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div><div className="text-[10px] text-slate-400 uppercase tracking-[0.2em] mb-1">Net Surplus</div><div className={`text-5xl font-black font-mono-num ${t>=0?'text-emerald-400 text-glow-green':'text-red-400 text-glow-red'}`}>${t.toLocaleString()}</div></div><div className="grid grid-cols-2 gap-3"><div onClick={() => setFilter(filter === 'machine' ? null : 'machine')} className="glass-panel p-3 rounded-2xl flex flex-col justify-between h-20 relative overflow-hidden cursor-pointer active:scale-95"><div className="absolute top-0 right-0 p-2 opacity-10"><Icon name="TrendingUp" size={32}/></div><div className="text-[9px] text-slate-400 uppercase tracking-widest font-bold">Machine</div><div className="font-mono-num font-bold text-lg text-emerald-400 text-glow-green">{s.m.toLocaleString()}</div></div><div onClick={() => setFilter(filter === 'stock' ? null : 'stock')} className="glass-panel p-3 rounded-2xl flex flex-col justify-between h-20 relative overflow-hidden cursor-pointer active:scale-95"><div className="absolute top-0 right-0 p-2 opacity-10"><Icon name="TrendingDown" size={32}/></div><div className="text-[9px] text-slate-400 uppercase tracking-widest font-bold">Stock</div><div className="font-mono-num font-bold text-lg text-rose-400 text-glow-red">{s.s.toLocaleString()}</div></div><div onClick={() => setFilter(filter === 'clockin' ? null : 'clockin')} className="glass-panel p-3 rounded-2xl flex flex-col justify-between h-20 relative overflow-hidden cursor-pointer active:scale-95"><div className="absolute top-0 right-0 p-2 opacity-10"><Icon name="TrendingUp" size={32}/></div><div className="text-[9px] text-slate-400 uppercase tracking-widest font-bold">Clock</div><div className="font-mono-num font-bold text-lg text-amber-400">{s.c.toLocaleString()}</div></div><div onClick={() => setFilter(filter === 'video' ? null : 'video')} className="glass-panel p-3 rounded-2xl flex flex-col justify-between h-20 relative overflow-hidden cursor-pointer active:scale-95"><div className="absolute top-0 right-0 p-2 opacity-10"><Icon name="TrendingUp" size={32}/></div><div className="text-[9px] text-slate-400 uppercase tracking-widest font-bold">Video</div><div className="font-mono-num font-bold text-lg text-blue-400 text-glow-blue">{s.v.toLocaleString()}</div></div></div>{filter && <DetailList type={filter} />}</div>);
        };

        const SettingsPage = ({user, settings, onUpdate, logout, readOnly}) => {
            if(readOnly) return <div className="text-center p-10 text-slate-500">唯讀模式 (Read Only)</div>;
            
            const [localSettings, setLocalSettings] = useState(settings);
            const [newVenue, setNewVenue] = useState(''); const [newSource, setNewSource] = useState('');
            const [isSaving, setIsSaving] = useState(false);
            const toast = useContext(ToastContext);
            const setModal = useContext(ModalContext);

            useEffect(() => { setLocalSettings(settings); }, [settings]);
            
            const addLocal = (k, val) => {
                if(val) {
                    const listKey = k === 'venue' ? 'venues' : 'sources';
                    setLocalSettings(prev => ({ ...prev, [listKey]: [...(prev[listKey]||[]), val] }));
                    if(k==='venue') setNewVenue(''); else setNewSource('');
                }
            };

            const delLocal = (k, val) => {
                setModal({type: 'confirm', props: {title: '刪除?', message: `確定刪除 "${val}"?`, onConfirm: () => {
                    const listKey = k === 'venue' ? 'venues' : 'sources';
                    setLocalSettings(prev => ({ ...prev, [listKey]: prev[listKey].filter(x => x !== val) }));
                }}});
            };

            const handleSaveAll = async () => {
                setIsSaving(true);
                // Also commit pending inputs if any
                let final = { ...localSettings };
                if (newVenue) final.venues = [...(final.venues||[]), newVenue];
                if (newSource) final.sources = [...(final.sources||[]), newSource];
                
                await onUpdate(final);
                setNewVenue(''); setNewSource('');
                setIsSaving(false);
                toast('設定已更新至資料庫', 'success');
            };

            return (<div className="space-y-4 px-6 pt-6 pb-24"><div className="glass-panel p-5 rounded-3xl flex items-center gap-4 border border-white/5"><div className="w-12 h-12 rounded-full bg-gradient-to-tr from-blue-600 to-purple-600 flex items-center justify-center font-bold text-xl shadow-lg">{user.displayName[0]}</div><div><div className="font-bold text-lg text-white">{user.displayName}</div><div className="text-[10px] text-slate-400">{user.email}</div></div></div><div className="glass-panel p-5 rounded-3xl space-y-3"><h3 className="font-bold text-slate-300 flex items-center gap-2 text-sm"><Icon name="UserCog" size={16}/> 暱稱</h3><div className="hk-input-group"><input value={localSettings.nickname||''} onChange={e=>setLocalSettings({...localSettings,nickname:e.target.value})} className="hk-input text-sm"/></div></div><div className="glass-panel p-5 rounded-3xl space-y-3"><h3 className="font-bold text-slate-300 flex items-center gap-2 text-sm"><Icon name="MapPin" size={16}/> 場地 (未儲存)</h3><div className="flex flex-wrap gap-2">{(localSettings.venues||[]).map(v=><span key={v} className="px-2 py-1 bg-blue-900/30 rounded-lg text-[10px] flex items-center gap-2 border border-blue-500/30 text-blue-200">{v}<button onClick={()=>delLocal('venue',v)}><Icon name="X" size={10}/></button></span>)}</div><div className="flex gap-2"><div className="hk-input-group flex-1"><input value={newVenue} onChange={e=>setNewVenue(e.target.value)} placeholder="新場地" className="hk-input text-sm py-1.5"/></div><button onClick={()=>addLocal('venue',newVenue)} className="px-3 bg-blue-600 rounded-xl"><Icon name="Plus" size={16}/></button></div></div><div className="glass-panel p-5 rounded-3xl space-y-3"><h3 className="font-bold text-slate-300 flex items-center gap-2 text-sm"><Icon name="Truck" size={16}/> 來源 (未儲存)</h3><div className="flex flex-wrap gap-2">{(localSettings.sources||[]).map(s=><span key={s} className="px-2 py-1 bg-purple-900/30 rounded-lg text-[10px] flex items-center gap-2 border border-purple-500/30 text-purple-200">{s}<button onClick={()=>delLocal('source',s)}><Icon name="X" size={10}/></button></span>)}</div><div className="flex gap-2"><div className="hk-input-group flex-1"><input value={newSource} onChange={e=>setNewSource(e.target.value)} placeholder="新來源" className="hk-input text-sm py-1.5"/></div><button onClick={()=>addLocal('source',newSource)} className="px-3 bg-purple-600 rounded-xl"><Icon name="Plus" size={16}/></button></div></div><button onClick={handleSaveAll} disabled={isSaving} className={`w-full py-3 rounded-2xl border font-bold transition-colors text-sm shadow-[0_0_15px_rgba(34,197,94,0.1)] flex items-center justify-center gap-2 ${isSaving ? 'bg-gray-600 border-gray-600 text-gray-300' : 'bg-green-500/10 text-green-400 border-green-500/20 hover:bg-green-500/20'}`}>{isSaving ? '儲存中...' : <><Icon name="Save" size={16}/> 儲存設定 (Save)</>}</button><button onClick={()=>{ setModal({type:'confirm',props:{title:'登出?',message:'確定要登出嗎?',onConfirm:logout}}) }} className="w-full py-3 rounded-2xl bg-red-500/10 text-red-400 border border-red-500/20 font-bold hover:bg-red-500/20 transition-colors text-sm">登出系統</button></div>);
        };

        const Login = ({ onLogin }) => {
            const [email, setEmail] = useState(''); const [pass, setPass] = useState('');
            const authAct = async (t) => { try { if(t==='g') await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); else if(t==='guest') {localStorage.setItem('guest',JSON.stringify({uid:'guest',displayName:'Guest',isGuest:true})); onLogin({uid:'guest',displayName:'Guest',isGuest:true});} else await auth.signInWithEmailAndPassword(email,pass); } catch(e){alert(e.message);} };
            return (<div className="min-h-screen flex items-center justify-center p-6 z-50 relative"><div className="glass-card p-8 rounded-[40px] w-full max-w-sm border border-white/10 shadow-2xl backdrop-blur-xl"><div className="text-center mb-10"><div className="w-20 h-20 bg-gradient-to-tr from-blue-600 to-purple-600 rounded-2xl mx-auto mb-4 flex items-center justify-center shadow-lg transform rotate-3"><Icon name="Gamepad2" size={32} className="text-white"/></div><h1 className="text-3xl font-black italic tracking-tighter text-white">MACHINE<span className="text-blue-500">PRO</span></h1><p className="text-slate-500 text-[10px] tracking-[0.4em] uppercase mt-2">Hong Kong Edition</p></div><div className="space-y-3"><button onClick={()=>authAct('g')} className="w-full py-3 bg-white text-black font-bold rounded-2xl flex justify-center items-center gap-3 hover:scale-105 transition-transform shadow-lg"><svg viewBox="0 0 24 24" width="18" height="18"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.84z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg> Google Login</button><div className="flex items-center gap-2 text-[10px] text-slate-600 py-1"><div className="h-px bg-slate-800 flex-1"></div>OR<div className="h-px bg-slate-800 flex-1"></div></div><div className="hk-input-group"><input placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} className="hk-input text-sm"/></div><div className="hk-input-group"><input type="password" placeholder="Password" value={pass} onChange={e=>setPass(e.target.value)} className="hk-input text-sm"/></div><button onClick={()=>authAct('e')} className="w-full py-3 bg-blue-600 font-bold rounded-2xl shadow-lg text-white hover:bg-blue-500 transition-colors text-sm">Login / Register</button><button onClick={()=>authAct('guest')} className="text-slate-500 w-full text-center text-[10px] hover:text-white transition-colors">訪客試用 Guest Mode</button></div></div></div>);
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('accounting');
            const [records, setRecords] = useState([]);
            const [settings, setSettings] = useState({ venues: ['旺角中心','現時點','信和中心'], sources: ['淘寶','日拍'], nickname: '機主' });
            const [monthlyEst, setMonthlyEst] = useState(0);
            const [showShareModal, setShowShareModal] = useState(false);
            const [viewingUser, setViewingUser] = useState(null);
            const [activePermissions, setActivePermissions] = useState(null);
            const [editingRecord, setEditingRecord] = useState(null);
            const [isOnline, setIsOnline] = useState(navigator.onLine);
            const [loading, setLoading] = useState(true);
            const setModal = useContext(ModalContext);

            useEffect(() => {
                const handleStatusChange = () => setIsOnline(navigator.onLine);
                window.addEventListener('online', handleStatusChange);
                window.addEventListener('offline', handleStatusChange);
                return () => {
                    window.removeEventListener('online', handleStatusChange);
                    window.removeEventListener('offline', handleStatusChange);
                };
            }, []);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (u) => {
                    if (u) {
                        setUser({ ...u, isGuest: false, displayName: u.displayName || '未命名' });
                        const s = await db.collection('artifacts').doc('recordmachine').collection('users').doc(u.uid).collection('settings').doc('profile').get();
                        if (s.exists) setSettings(prev => ({...prev, ...s.data()}));
                        // Real-time listener
                        db.collection('artifacts').doc('recordmachine').collection('users').doc(u.uid).collection('records').orderBy('date', 'desc').limit(200)
                            .onSnapshot(snap => setRecords(snap.docs.map(d => ({id: d.id, ...d.data()}))), err => console.error(err));
                    } else {
                        const g = localStorage.getItem('guest');
                        if (g) { setUser(JSON.parse(g)); setRecords(JSON.parse(localStorage.getItem('guest_records') || '[]')); setSettings(JSON.parse(localStorage.getItem('guest_settings') || JSON.stringify(settings))); }
                    }
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            // Viewing User Listener logic (same as before)
            useEffect(() => {
                if (viewingUser) {
                    const unsub = db.collection('artifacts').doc('recordmachine').collection('public').doc('data').collection('shares').doc(viewingUser.id).onSnapshot(doc => { if(doc.exists) setActivePermissions(doc.data().permissions || {}); else { alert("分享已停止"); setViewingUser(null); } });
                    const unsubRecords = db.collection('artifacts').doc('recordmachine').collection('users').doc(viewingUser.ownerUid).collection('records').orderBy('date', 'desc').limit(200).onSnapshot(snap => setRecords(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                    const unsubSettings = db.collection('artifacts').doc('recordmachine').collection('users').doc(viewingUser.ownerUid).collection('settings').doc('profile').onSnapshot(doc => { if(doc.exists) setSettings(doc.data()); });
                    return () => { unsub(); unsubRecords(); unsubSettings(); };
                }
            }, [viewingUser]);

            useEffect(() => {
                if (!records.length) { setMonthlyEst(0); return; }
                const ym = new Date().toISOString().slice(0, 7);
                const total = records.filter(r => r.date.startsWith(ym) && ['machine', 'video', 'clockin'].includes(r.type)).reduce((sum, r) => sum + (Number(r.amount) || 0), 0);
                setMonthlyEst(total);
            }, [records]);

            const switchViewUser = async (shareObj) => { if (!shareObj) window.location.reload(); else setViewingUser(shareObj); };
            const handleAdd = async (d) => { const nr={...d,id:String(Date.now()),createdAt:new Date().toISOString()}; if(!user.isGuest) { try { await db.collection('artifacts').doc('recordmachine').collection('users').doc(user.uid).collection('records').doc(nr.id).set(nr); } catch(e) { setModal({type:'confirm',props:{title:'權限錯誤',message:'無法寫入資料庫，請檢查規則。',onConfirm:()=>{}}}); throw e; } } else { const ns=[nr,...records]; setRecords(ns); localStorage.setItem('guest_records',JSON.stringify(ns)); } };
            const handleUpdate = async (d) => { if(!user.isGuest) await db.collection('artifacts').doc('recordmachine').collection('users').doc(user.uid).collection('records').doc(d.id).set(d,{merge:true}); else { const ns=records.map(r=>r.id===d.id?d:r); setRecords(ns); localStorage.setItem('guest_records',JSON.stringify(ns)); } setEditingRecord(null); };
            const handleDelete = async (id) => { if(!confirm("刪除?"))return; if(!user.isGuest) await db.collection('artifacts').doc('recordmachine').collection('users').doc(user.uid).collection('records').doc(id).delete(); else { const ns=records.filter(r=>r.id!==id); setRecords(ns); localStorage.setItem('guest_records',JSON.stringify(ns)); } setEditingRecord(null); };
            
            const handleSettingsUpdate = async (newSettings) => {
                if(user.isGuest) { setSettings(newSettings); localStorage.setItem('guest_settings',JSON.stringify(newSettings)); }
                else {
                    try { await db.collection('artifacts').doc('recordmachine').collection('users').doc(user.uid).collection('settings').doc('profile').set(newSettings, {merge:true}); } 
                    catch(e) { throw e; }
                }
            };
            
            // Helper for centralized edits to fix reference error
            const handleEdit = (r) => setEditingRecord(r);

            if (loading) return <div className="min-h-screen flex items-center justify-center text-blue-500 font-bold">LOADING...</div>;
            if (!user) return <Login onLogin={(u) => { setUser(u); if(u.isGuest) loadGuestData(); }} />;

            const isBlocked = viewingUser && activePermissions && activePermissions[view] === false;

            return (
                <div className="min-h-screen pb-10">
                    <TopBar user={user} viewingUser={viewingUser} monthlyEst={monthlyEst} isOnline={isOnline} switchViewUser={switchViewUser} setShowShareModal={setShowShareModal} setView={setView} />
                    <main className="pt-36 px-4 container mx-auto max-w-lg">
                        <AnimatePresence mode="wait">
                            {isBlocked ? (
                                <motion.div key="blocked" initial={{opacity:0}} animate={{opacity:1}} className="h-[50vh] flex flex-col items-center justify-center text-center p-6 glass-card rounded-3xl border-red-500/30">
                                    <Icon name="Lock" size={48} className="text-red-500 mb-4"/><h2 className="text-xl font-bold text-red-400">存取被拒絕</h2>
                                </motion.div>
                            ) : (
                                <motion.div key={view} initial={{opacity:0, y:10}} animate={{opacity:1, y:0}} exit={{opacity:0, y:-10}} transition={{duration:0.25}}>
                                    {view === 'accounting' && <Accounting records={records} onAdd={handleAdd} onEdit={handleEdit} settings={settings} readOnly={!!viewingUser} nav={<NavBar current={view} setView={setView} />} />}
                                    {view === 'data' && <DataFolder records={records} onEdit={!viewingUser ? handleEdit : undefined} />}
                                    {view === 'video' && <VideoPage records={records} onAdd={handleAdd} onEdit={handleEdit} readOnly={!!viewingUser} />}
                                    {view === 'clock' && <ClockPage records={records} onAdd={handleAdd} onEdit={handleEdit} user={settings.nickname} readOnly={!!viewingUser} />}
                                    {view === 'summary' && <Summary records={records} />}
                                    {view === 'settings' && <SettingsPage user={user} settings={settings} onUpdate={handleSettingsUpdate} logout={() => {setUser(null); auth.signOut();}} readOnly={!!viewingUser} />}
                                </motion.div>
                            )}
                        </AnimatePresence>
                    </main>
                    <AnimatePresence>
                        {editingRecord && !viewingUser && <EditModal record={editingRecord} onClose={()=>setEditingRecord(null)} onUpdate={handleUpdate} onDelete={handleDelete} settings={settings} />}
                        {showShareModal && <ShareCenter user={user} onClose={()=>setShowShareModal(false)} onSwitchUser={switchViewUser} />}
                    </AnimatePresence>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<UIProvider><App /></UIProvider>);
    </script>
</body>
</html>