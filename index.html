<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>機械收支管理系統</title>
    <!-- Theme: Modern Clean Dark (Interaction Hotfix 3.6.2) -->
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+HK:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Safety Stubs: Prevents errors before main script loads -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const t = document.getElementById('toast');
            if(t) {
                document.getElementById('toast-msg').innerText = "系統錯誤: " + msg;
                document.getElementById('toast-msg').classList.add('text-red-400');
                t.classList.remove('opacity-0', 'translate-y-4');
            }
            console.error("Global Error:", msg, error);
            return false;
        };

        function stubWarn() { 
            const t = document.getElementById('toast');
            if(t) {
                document.getElementById('toast-msg').innerText = "系統正在啟動中，請稍候...";
                t.classList.remove('opacity-0', 'translate-y-4');
                setTimeout(() => t.classList.add('opacity-0', 'translate-y-4'), 3000);
            }
        }
        
        const allFns = [
            'handleGoogleLogin','handleEmailLogin','handleEmailRegister','handleGuestLogin','handleLogout',
            'saveRecord','saveVideoRecord','clockIn','clockOut','sendInvite', 
            'navTo', 'openSettingsModal', 'openShareModal', 'openNotifications', 
            'switchInputMode', 'toggleMachineType', 'openDrillDown', 'closeModal', 
            'saveSettings', 'saveSharingSettings', 'addSettingItem', 'removeSettingItem', 
            'openEditRecord', 'openEditVideo', 'openEditCheckin', 'updateCurrentRecord', 
            'deleteCurrentRecord', 'switchToMyData', 'exitSharedMode', 'selectOption', 'toggleSelect',
            'acceptInvite', 'rejectInvite', 'switchToSharedView'
        ];
        allFns.forEach(f => window[f] = stubWarn);
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['"Noto Sans HK"', '"Inter"', 'sans-serif'],
                        'mono': ['"Inter"', 'monospace'],
                    },
                    colors: {
                        bg: { main: '#0f1115', card: '#181b21', hover: '#22262e' },
                        accent: { blue: '#3b82f6', cyan: '#06b6d4', purple: '#8b5cf6', green: '#10b981', red: '#ef4444' }
                    },
                    boxShadow: {
                        'card': '0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.1)',
                        'glow': '0 0 15px rgba(59, 130, 246, 0.15)',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #0f1115;
            color: #e2e8f0;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior: none;
            overflow: hidden;
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .app-bg {
            background: radial-gradient(circle at 50% 0%, #1e2532 0%, #0f1115 100%);
            position: absolute;
            inset: 0;
            z-index: 0;
        }

        .modern-card {
            background-color: #181b21;
            border: 1px solid #2a2e36;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }

        .modern-input {
            background-color: #22262e;
            border: 1px solid #333842;
            color: #f1f5f9;
            transition: all 0.2s ease;
        }
        .modern-input:focus {
            background-color: #2a2e36;
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
            transition: all 0.2s;
        }
        .btn-primary:active { background-color: #2563eb; transform: scale(0.98); }
        
        .btn-secondary {
            background-color: #22262e;
            color: #94a3b8;
            border: 1px solid #333842;
            transition: all 0.2s;
        }
        .btn-secondary:active { background-color: #2a2e36; transform: scale(0.98); }

        .nav-item { color: #64748b; transition: all 0.2s; }
        .nav-item.active { color: #3b82f6; }
        .nav-item.active i { transform: translateY(-2px); }

        .chart-container { position: relative; width: 100%; height: 260px; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333842; border-radius: 4px; }
        .safe-area-pb { padding-bottom: env(safe-area-inset-bottom, 20px); }

        .custom-select-options {
            position: absolute; top: 100%; left: 0; right: 0; z-index: 50;
            background: #22262e; border: 1px solid #333842; border-radius: 0.5rem;
            margin-top: 4px; max-height: 200px; overflow-y: auto; display: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }
        .custom-select-options.open { display: block; }
        .custom-option { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #2a2e36; }
        .custom-option:hover { background: #2a2e36; color: #3b82f6; }

        .tag-chip {
            background: #1e293b; border: 1px solid #334155; color: #94a3b8;
            padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; display: flex; align-items: center; gap: 6px;
        }

        .toggle-checkbox:checked { right: 0; border-color: #3b82f6; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3b82f6; }

        .notif-dot {
            position: absolute; top: 2px; right: 2px; width: 8px; height: 8px;
            background-color: #ef4444; border-radius: 50%; border: 1px solid #181b21;
            display: none;
        }
        .notif-dot.active { display: block; }
        
        .shared-banner { background-color: #312e81; border-bottom: 1px solid #4f46e5; }

        #app-container { position: relative; width: 100%; height: 100%; }
        @media (min-width: 768px) {
            #app-container { height: 95vh; max-height: 900px; border-radius: 16px; border: 1px solid #2a2e36; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); overflow: hidden; }
            .page-section { padding: 2rem; }
        }
    </style>
</head>
<body class="text-slate-200">
    <div class="app-bg"></div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-50 flex flex-col justify-center items-center p-6 bg-[#0f1115]">
        <div class="w-full max-w-sm">
            <div class="text-center mb-12">
                <div class="w-16 h-16 mx-auto bg-blue-600 rounded-2xl flex items-center justify-center mb-6 shadow-lg shadow-blue-900/20">
                    <i class="fas fa-robot text-3xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-white tracking-tight mb-2">機械收支管理系統</h1>
                <p class="text-slate-500 text-xs font-mono">VERSION 3.6.2</p>
            </div>

            <div id="auth-view-login" class="space-y-4">
                <button onclick="handleGoogleLogin()" class="w-full bg-white text-slate-900 font-bold py-3.5 px-4 rounded-xl flex items-center justify-center gap-3 transition active:scale-[0.98]">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-5 h-5" alt="Google">
                    <span>Google 登入</span>
                </button>

                <div class="relative my-6">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-slate-800"></div></div>
                    <div class="relative flex justify-center text-xs"><span class="px-3 bg-[#0f1115] text-slate-500">或</span></div>
                </div>

                <input type="email" id="login-email" placeholder="電子郵件" class="w-full modern-input rounded-xl px-4 py-3.5 text-sm">
                <input type="password" id="login-pass" placeholder="密碼" class="w-full modern-input rounded-xl px-4 py-3.5 text-sm">
                
                <button onclick="handleEmailLogin()" class="w-full btn-primary py-3.5 rounded-xl text-sm font-bold shadow-lg shadow-blue-900/20">
                    登入帳戶
                </button>

                <div class="flex justify-between items-center text-xs mt-6 px-1">
                    <button onclick="handleGuestLogin()" class="text-slate-500 hover:text-slate-300">訪客試用</button>
                    <button onclick="toggleAuthView('register')" class="text-blue-500 hover:text-blue-400 font-medium">註冊新帳號</button>
                </div>
            </div>

            <div id="auth-view-register" class="space-y-4 hidden">
                <h3 class="text-white text-center font-bold mb-6">註冊帳戶</h3>
                <input type="email" id="reg-email" placeholder="輸入電子郵件" class="w-full modern-input rounded-xl px-4 py-3.5 text-sm">
                <input type="password" id="reg-pass" placeholder="設定密碼" class="w-full modern-input rounded-xl px-4 py-3.5 text-sm">
                <button onclick="handleEmailRegister()" class="w-full btn-primary py-3.5 rounded-xl text-sm font-bold">註冊</button>
                <button onclick="toggleAuthView('login')" class="w-full text-slate-500 text-xs py-2 hover:text-slate-300">返回登入</button>
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden flex flex-col mx-auto bg-[#0f1115] relative z-10 md:bg-[#181b21]">
        
        <!-- Shared Mode Banner -->
        <div id="shared-mode-banner" class="hidden px-4 py-2 text-xs text-center text-indigo-200 font-medium shared-banner z-30 sticky top-0 flex justify-between items-center">
            <span><i class="fas fa-eye mr-2"></i> 正在檢視共享資料</span>
            <button onclick="exitSharedMode()" class="bg-indigo-700/50 px-3 py-0.5 rounded text-[10px] hover:bg-indigo-600 transition">退出</button>
        </div>

        <!-- Header -->
        <div class="px-5 pt-safe-top pb-3 flex justify-between items-center z-20 bg-[#0f1115]/95 backdrop-blur-sm sticky border-b border-slate-800 pt-10 sm:pt-8 top-0" id="main-header">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="openSettingsModal()">
                <div class="relative">
                    <img id="user-avatar-img" src="" class="hidden w-10 h-10 rounded-full border border-slate-700 object-cover">
                    <div id="user-avatar-placeholder" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center text-slate-400 font-bold text-sm border border-slate-700">U</div>
                    <div class="absolute bottom-0 right-0 w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-[#0f1115]"></div>
                </div>
                <div>
                    <h2 class="font-bold text-slate-200 text-sm" id="display-username">使用者</h2>
                    <div id="db-status-badge" class="text-[10px] text-slate-500 font-mono mt-0.5 flex items-center gap-1.5">
                        <span class="w-1.5 h-1.5 rounded-full bg-slate-600"></span> OFFLINE
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="openNotifications()" class="w-9 h-9 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-slate-200 flex items-center justify-center transition border border-slate-700 relative">
                    <i class="fas fa-bell text-sm"></i>
                    <div id="notif-dot" class="notif-dot"></div>
                </button>
                <button onclick="openShareModal()" class="w-9 h-9 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-slate-200 flex items-center justify-center transition border border-slate-700"><i class="fas fa-share-nodes text-sm"></i></button>
                <button onclick="openSettingsModal()" class="w-9 h-9 rounded-lg bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-slate-200 flex items-center justify-center transition border border-slate-700"><i class="fas fa-cog text-sm"></i></button>
            </div>
        </div>

        <!-- Content Area -->
        <div id="content-area" class="flex-1 overflow-y-auto pb-24 scroll-smooth relative z-10 min-h-0">
            
            <!-- Page: Counting -->
            <div id="page-counting" class="page-section p-5 space-y-5">
                <!-- Forecast Card -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <div class="modern-card rounded-2xl p-6 relative overflow-hidden bg-gradient-to-br from-blue-900/20 to-slate-900/50">
                        <div class="relative z-10">
                            <p class="text-blue-400 text-xs font-bold tracking-wider mb-2 uppercase">本月預計營收 (機台)</p>
                            <h1 class="text-4xl font-mono font-bold text-white tracking-tight" id="projected-income">$0</h1>
                        </div>
                        <div class="absolute right-4 top-4 text-blue-500/10"><i class="fas fa-chart-line text-8xl"></i></div>
                    </div>
                    
                    <div class="modern-card p-1.5 rounded-xl flex relative h-14 self-center">
                        <div id="toggle-bg" class="absolute w-[calc(50%-6px)] h-[calc(100%-12px)] bg-slate-700 rounded-lg shadow-sm transition-all duration-300 top-1.5 left-1.5"></div>
                        <button onclick="switchInputMode('income')" class="flex-1 py-2 text-center text-xs font-bold z-10 text-white tracking-wide transition-colors" id="btn-income">機台收入</button>
                        <button onclick="switchInputMode('stock')" class="flex-1 py-2 text-center text-xs font-bold z-10 text-slate-500 tracking-wide transition-colors" id="btn-stock">網上入貨</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <!-- Forms -->
                    <div class="input-form-container">
                        <div id="form-income" class="modern-card rounded-2xl p-5 space-y-4 h-full border-t-4 border-t-blue-500">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1.5"><label class="text-[10px] font-bold text-slate-500 uppercase">日期</label><input type="date" id="income-date" class="w-full modern-input rounded-lg p-2.5 text-sm"></div>
                                <div class="space-y-1.5" id="venue-selector-container"></div>
                            </div>
                            
                            <div class="space-y-2">
                                <label class="text-[10px] font-bold text-slate-500 uppercase">機台類型</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <label class="cursor-pointer group"><input type="radio" name="machineType" value="standard" class="peer hidden" checked onchange="toggleMachineType()"><div class="p-2.5 text-center rounded-lg bg-slate-800/50 border border-slate-700 peer-checked:bg-blue-900/30 peer-checked:border-blue-600 peer-checked:text-blue-400 text-xs font-bold transition-all">標準機</div></label>
                                    <label class="cursor-pointer group"><input type="radio" name="machineType" value="mini" class="peer hidden" onchange="toggleMachineType()"><div class="p-2.5 text-center rounded-lg bg-slate-800/50 border border-slate-700 peer-checked:bg-blue-900/30 peer-checked:border-blue-600 peer-checked:text-blue-400 text-xs font-bold transition-all">迷你機</div></label>
                                </div>
                            </div>

                            <div id="standard-amount-input">
                                <div class="relative bg-slate-900/50 rounded-lg border border-slate-700 px-4 py-2 mt-2 focus-within:border-blue-500 transition-colors">
                                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 font-mono">$</span>
                                    <input type="number" id="income-amount" placeholder="0" class="w-full bg-transparent text-2xl font-bold text-right text-white focus:outline-none font-mono" oninput="calculateTotalIncome()">
                                </div>
                            </div>
                            <div id="mini-amount-input" class="hidden grid grid-cols-2 gap-3 mt-2"><div class="relative bg-slate-900/50 rounded-lg border border-slate-700 px-3 py-2"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] text-slate-500 font-bold">上</span><input type="number" id="income-top" placeholder="0" class="w-full bg-transparent text-lg font-bold text-right text-white focus:outline-none font-mono" oninput="calculateTotalIncome()"></div><div class="relative bg-slate-900/50 rounded-lg border border-slate-700 px-3 py-2"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-[10px] text-slate-500 font-bold">下</span><input type="number" id="income-bottom" placeholder="0" class="w-full bg-transparent text-lg font-bold text-right text-white focus:outline-none font-mono" oninput="calculateTotalIncome()"></div></div>
                            
                            <div class="flex justify-between items-center py-3 border-t border-slate-800 mt-2">
                                <span class="text-slate-500 text-xs font-bold">本次總計</span>
                                <span class="text-xl font-bold text-blue-400 font-mono" id="income-display-total">$0</span>
                            </div>
                            <input type="text" id="income-remarks" placeholder="備註..." class="w-full modern-input rounded-lg p-3 text-sm">
                            <button type="button" onclick="saveRecord('income')" class="w-full btn-primary font-bold py-3.5 rounded-xl shadow-lg active:scale-[0.98] transition-all flex justify-center items-center gap-2 write-action mt-2"><i class="fas fa-check"></i> 儲存記錄</button>
                        </div>

                        <!-- Stock Form -->
                        <div id="form-stock" class="hidden modern-card rounded-2xl p-6 space-y-5 h-full border-t-4 border-t-red-500">
                            <div class="grid grid-cols-2 gap-5"><div class="space-y-1.5"><label class="text-[10px] font-bold text-slate-500 uppercase">日期</label><input type="date" id="stock-date" class="w-full modern-input rounded-lg p-2.5 text-sm"></div><div class="space-y-1.5" id="stock-source-selector-container"></div></div>
                            <input type="text" id="stock-name" placeholder="貨品名稱" class="w-full modern-input rounded-lg p-3 text-sm">
                            <div class="grid grid-cols-2 gap-5"><input type="number" id="stock-qty" placeholder="數量" class="w-full modern-input rounded-lg p-3 text-sm font-mono text-center"><input type="number" id="stock-cost" placeholder="成本 $" class="w-full modern-input rounded-lg p-3 text-sm font-mono text-center text-red-400 border-red-500/30 focus:border-red-500"></div>
                            <button type="button" onclick="saveRecord('stock')" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-3.5 rounded-xl shadow-lg active:scale-[0.98] transition-all flex justify-center items-center gap-2 write-action mt-2"><i class="fas fa-box"></i> 記錄支出</button>
                        </div>
                    </div>
                    
                    <!-- Recent List -->
                    <div class="h-full flex flex-col">
                        <h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3 pl-1">近期活動</h3>
                        <div id="recent-records-list" class="space-y-2 pb-4 flex-1 overflow-y-auto max-h-[500px] pr-1"></div>
                    </div>
                </div>
            </div>

            <!-- Page: Data -->
            <div id="page-data" class="hidden p-5 page-section">
                <h3 class="text-lg font-bold text-white mb-5 flex items-center gap-2"><i class="fas fa-database text-blue-500"></i> 資料庫總覽</h3>
                <div id="data-tree-container" class="space-y-4 pb-20 md:grid md:grid-cols-2 md:gap-5 md:space-y-0"></div>
            </div>

            <!-- Page: Video -->
            <div id="page-video" class="hidden p-5 page-section space-y-5">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-5">
                    <div class="modern-card rounded-2xl p-5 relative col-span-1 border-t-4 border-t-purple-500"><div class="flex justify-between items-start"><div><h2 class="text-xl font-bold text-white mb-1">內容創作</h2><p class="text-purple-400 text-xs font-mono">$25.00 / 條</p></div><div class="w-10 h-10 rounded-lg bg-purple-500/10 flex items-center justify-center text-purple-400"><i class="fas fa-video"></i></div></div><div class="mt-6 space-y-3 input-form-container"><input type="text" id="video-title" placeholder="影片標題" class="w-full modern-input rounded-lg p-3 text-sm"><input type="date" id="video-date" class="w-full modern-input rounded-lg p-3 text-sm"><button type="button" onclick="saveVideoRecord()" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 rounded-xl shadow-lg active:scale-95 transition write-action"><i class="fas fa-plus mr-2"></i> 新增記錄</button></div></div>
                    <div class="col-span-1 md:col-span-2"><h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3 pl-1">本月影片列表</h3><div id="video-list" class="space-y-2 md:grid md:grid-cols-2 md:gap-3 md:space-y-0"></div></div>
                </div>
            </div>

            <!-- Page: Check-in -->
            <div id="page-checkin" class="hidden p-5 page-section h-full flex flex-col justify-center">
                <div class="flex-1 flex flex-col justify-center items-center relative">
                    <div class="relative w-72 h-72 rounded-full border-[6px] border-slate-800 bg-[#12141a] flex items-center justify-center mb-10 shadow-xl">
                        <div class="text-center">
                            <div id="clock-time" class="text-5xl font-mono font-bold text-white tracking-tight">00:00:00</div>
                            <div id="clock-date" class="text-sm text-slate-500 mt-2 font-bold tracking-widest uppercase">READY</div>
                        </div>
                    </div>
                    <div class="w-full max-w-xs grid grid-cols-2 gap-4 input-form-container">
                        <button type="button" onclick="clockIn()" id="btn-clock-in" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition-all text-lg write-action flex flex-col items-center justify-center gap-1"><i class="fas fa-fingerprint text-xl"></i> 上班</button>
                        <button type="button" onclick="clockOut()" id="btn-clock-out" class="bg-slate-800 text-slate-600 font-bold py-4 rounded-2xl cursor-not-allowed text-lg write-action flex flex-col items-center justify-center gap-1" disabled><i class="fas fa-power-off text-xl"></i> 下班</button>
                    </div>
                </div>
                <div class="mt-8"><h3 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest mb-3 text-center">今日打卡紀錄</h3><div id="checkin-list" class="space-y-2 max-h-40 overflow-y-auto px-2"></div></div>
            </div>

            <!-- Page: Settlement -->
            <div id="page-settlement" class="hidden p-5 page-section space-y-5">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                    <button onclick="openDrillDown('surplus')" class="w-full text-left modern-card rounded-2xl p-6 relative group transition-all active:scale-[0.99] hover:border-emerald-500/50"><div class="flex justify-between items-start"><div><p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">總盈餘 (Surplus)</p><h1 class="text-4xl font-mono font-bold text-emerald-400" id="settle-net-income">$0</h1><p class="text-[10px] text-emerald-600 mt-1 font-medium">總營收 - 總支出</p></div><div class="w-12 h-12 rounded-xl bg-emerald-500/10 flex items-center justify-center"><i class="fas fa-coins text-xl text-emerald-400"></i></div></div></button>
                    <button onclick="openDrillDown('gross_income')" class="w-full text-left modern-card rounded-2xl p-6 relative group transition-all active:scale-[0.99] hover:border-blue-500/50"><div class="flex justify-between items-start"><div><p class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-2">淨總收入 (Total Gross)</p><h1 class="text-4xl font-mono font-bold text-blue-400" id="settle-total-income">$0</h1><p class="text-[10px] text-blue-500/70 mt-1 font-medium">機台 + 影片 + 打卡</p></div><div class="w-12 h-12 rounded-xl bg-blue-500/10 flex items-center justify-center"><i class="fas fa-wallet text-xl text-blue-400"></i></div></div></button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <button onclick="openDrillDown('machine_income')" class="w-full text-left modern-card p-4 rounded-xl transition-all active:scale-[0.98] hover:bg-slate-800"><p class="text-slate-500 text-[10px] uppercase font-bold tracking-wider">機台收入</p><p class="text-lg font-bold text-slate-200 font-mono mt-1" id="settle-machine-net">$0</p></button>
                    <button onclick="openDrillDown('video')" class="w-full text-left modern-card p-4 rounded-xl transition-all active:scale-[0.98] hover:bg-slate-800"><p class="text-slate-500 text-[10px] uppercase font-bold tracking-wider">影片收入</p><p class="text-lg font-bold text-slate-200 font-mono mt-1" id="settle-video">$0</p></button>
                    <button onclick="openDrillDown('wages')" class="w-full text-left modern-card p-4 rounded-xl transition-all active:scale-[0.98] hover:bg-slate-800"><p class="text-slate-500 text-[10px] uppercase font-bold tracking-wider">打卡工資</p><p class="text-lg font-bold text-slate-200 font-mono mt-1" id="settle-wages">$0</p></button>
                    <button onclick="openDrillDown('stock')" class="w-full text-left modern-card p-4 rounded-xl transition-all active:scale-[0.98] hover:bg-slate-800"><p class="text-slate-500 text-[10px] uppercase font-bold tracking-wider">入貨支出</p><p class="text-lg font-bold text-red-400 font-mono mt-1" id="settle-stock">$0</p></button>
                </div>
                <div class="modern-card p-5 rounded-2xl h-72"><div class="chart-container h-full"><canvas id="financeChart"></canvas></div></div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="px-2 py-2 flex justify-around items-center z-40 bg-[#13161c] border-t border-slate-800 safe-area-pb absolute bottom-0 w-full md:w-[calc(100%-2px)] md:rounded-b-2xl md:left-[1px]">
            <button onclick="navTo('counting')" class="nav-item active w-full py-3 flex flex-col items-center group" data-target="counting"><i class="fas fa-calculator text-lg mb-1 transition-transform group-hover:scale-110"></i><span class="text-[10px] font-bold tracking-wide">記數</span></button>
            <button onclick="navTo('data')" class="nav-item w-full py-3 flex flex-col items-center group hover:text-slate-300" data-target="data"><i class="fas fa-folder text-lg mb-1 transition-transform group-hover:scale-110"></i><span class="text-[10px] font-bold tracking-wide">資料</span></button>
            <button onclick="navTo('video')" class="nav-item w-full py-3 flex flex-col items-center group hover:text-slate-300" data-target="video"><i class="fas fa-play-circle text-lg mb-1 transition-transform group-hover:scale-110"></i><span class="text-[9px] font-bold tracking-wide">影片</span></button>
            <button onclick="navTo('checkin')" class="nav-item w-full py-3 flex flex-col items-center group hover:text-slate-300" data-target="checkin"><i class="fas fa-clock text-lg mb-1 transition-transform group-hover:scale-110"></i><span class="text-[9px] font-bold tracking-wide">打卡</span></button>
            <button onclick="navTo('settlement')" class="nav-item w-full py-3 flex flex-col items-center group hover:text-slate-300" data-target="settlement"><i class="fas fa-chart-pie text-lg mb-1 transition-transform group-hover:scale-110"></i><span class="text-[9px] font-bold tracking-wide">結算</span></button>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="modal-edit" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm"><div class="w-full max-w-sm modern-card p-6 rounded-2xl shadow-2xl scale-100 transition-transform"><h3 class="text-lg font-bold text-white mb-5 flex items-center gap-3 border-b border-slate-700 pb-3"><i class="fas fa-pen-to-square text-blue-500"></i> 編輯記錄</h3><div id="edit-form-container" class="space-y-4 mb-6"></div><div class="flex gap-3"><button type="button" onclick="closeModal('modal-edit')" class="flex-1 btn-secondary py-3 rounded-lg font-bold text-sm">取消</button><button type="button" onclick="deleteCurrentRecord()" class="flex-1 bg-red-500/10 text-red-500 border border-red-500/20 hover:bg-red-500/20 py-3 rounded-lg font-bold text-sm">刪除</button><button type="button" onclick="updateCurrentRecord()" class="flex-1 btn-primary py-3 rounded-lg font-bold text-sm">儲存</button></div></div></div>
    
    <!-- Drill Down Modal -->
    <div id="modal-drilldown" class="hidden fixed inset-0 z-[100] flex items-end sm:items-center justify-center bg-black/70 backdrop-blur-sm"><div class="w-full max-w-md h-[80vh] bg-[#181b21] rounded-t-2xl sm:rounded-2xl p-6 border-t border-slate-700 flex flex-col shadow-2xl"><div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4"><h3 class="text-lg font-bold text-white tracking-wide" id="drilldown-title">詳細記錄</h3><button onclick="closeModal('modal-drilldown')" class="w-8 h-8 rounded-full bg-slate-800 text-slate-400 flex items-center justify-center hover:bg-slate-700 transition"><i class="fas fa-times"></i></button></div><div id="drilldown-list" class="flex-1 overflow-y-auto space-y-2 pr-1"></div></div></div>

    <!-- Settings & Share & Notif Modals -->
    <div id="modal-settings" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm"><div class="w-full max-w-md modern-card p-6 rounded-2xl"><h3 class="text-lg font-bold text-white mb-6 border-b border-slate-700 pb-4">系統設定</h3><label class="text-[10px] font-bold text-slate-500 uppercase block mb-2">顯示暱稱</label><input type="text" id="settings-nickname" class="w-full modern-input rounded-lg p-3 mb-4 text-sm"><label class="text-[10px] font-bold text-slate-500 uppercase block mb-2">自定義場地</label><div class="flex gap-2 mb-4"><input type="text" id="new-venue-input" class="flex-1 modern-input rounded-lg p-3 text-sm" placeholder="輸入場地名稱..." onkeypress="if(event.key==='Enter') addSettingItem('venues')"><button type="button" onclick="addSettingItem('venues')" class="bg-slate-700 hover:bg-blue-600 text-white w-10 rounded-lg transition flex items-center justify-center"><i class="fas fa-plus"></i></button></div><div id="venues-list" class="flex flex-wrap gap-2 mb-6 min-h-[30px]"></div><label class="text-[10px] font-bold text-slate-500 uppercase block mb-2">自定義入貨來源</label><div class="flex gap-2 mb-4"><input type="text" id="new-source-input" class="flex-1 modern-input rounded-lg p-3 text-sm" placeholder="輸入來源名稱..." onkeypress="if(event.key==='Enter') addSettingItem('sources')"><button type="button" onclick="addSettingItem('sources')" class="bg-slate-700 hover:bg-blue-600 text-white w-10 rounded-lg transition flex items-center justify-center"><i class="fas fa-plus"></i></button></div><div id="sources-list" class="flex flex-wrap gap-2 mb-6 min-h-[30px]"></div><button type="button" onclick="saveSettings()" class="w-full btn-primary py-3 rounded-lg font-bold text-sm mb-3">儲存變更</button><button type="button" onclick="handleLogout()" class="w-full border border-red-500/30 text-red-500 hover:bg-red-500/10 py-3 rounded-lg font-bold text-sm transition mb-3">登出帳戶</button><button type="button" onclick="closeModal('modal-settings')" class="w-full text-slate-500 text-sm hover:text-white transition">取消</button></div></div>
    
    <div id="modal-notif" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm"><div class="w-full max-w-md modern-card p-6 rounded-2xl"><div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-4"><h3 class="text-lg font-bold text-white"><i class="fas fa-bell text-blue-500 mr-2"></i>通知中心</h3><button onclick="closeModal('modal-notif')" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button></div><div id="notif-list" class="space-y-3 max-h-80 overflow-y-auto mb-4"></div><div id="shared-view-selector" class="border-t border-slate-700 pt-4 hidden"><p class="text-xs text-slate-400 mb-2 font-bold uppercase">切換檢視模式</p><div class="grid grid-cols-1 gap-2" id="shared-users-list"></div><button onclick="switchToMyData()" class="w-full mt-4 btn-secondary py-2 rounded-lg text-sm">返回我的資料</button></div></div></div>

    <div id="modal-share" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm"><div class="w-full max-w-md modern-card p-6 rounded-2xl"><h3 class="text-lg font-bold text-white mb-2">資料分享管理</h3><p class="text-xs text-slate-400 mb-6">邀請他人查看您的資料 (唯讀權限)。</p><div class="flex gap-2 mb-6"><input type="email" id="share-email" placeholder="對方 Email" class="flex-1 modern-input rounded-lg p-3 text-sm"><button onclick="sendInvite()" class="btn-primary px-4 rounded-lg font-bold"><i class="fas fa-paper-plane"></i></button></div><h4 class="text-[10px] font-bold text-slate-500 uppercase mb-3 tracking-wider">已發出的邀請</h4><div id="sent-invites-list" class="space-y-2 max-h-40 overflow-y-auto mb-6"></div><div class="space-y-4 mb-8"><div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg border border-slate-700"><span class="text-sm font-bold text-slate-300">允許查看記帳明細</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="share-toggle-records" class="sr-only peer toggle-checkbox" checked><div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500 toggle-label"></div></label></div><div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg border border-slate-700"><span class="text-sm font-bold text-slate-300">允許查看影片列表</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="share-toggle-videos" class="sr-only peer toggle-checkbox" checked><div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500 toggle-label"></div></label></div><div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg border border-slate-700"><span class="text-sm font-bold text-slate-300">允許查看打卡記錄</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="share-toggle-checkin" class="sr-only peer toggle-checkbox" checked><div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500 toggle-label"></div></label></div><div class="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg border border-slate-700"><span class="text-sm font-bold text-slate-300">允許查看結算報表</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="share-toggle-settlement" class="sr-only peer toggle-checkbox" checked><div class="w-11 h-6 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500 toggle-label"></div></label></div></div><button type="button" onclick="saveSharingSettings()" class="w-full btn-primary py-3 rounded-lg font-bold text-sm">儲存設定</button><button type="button" onclick="closeModal('modal-share')" class="w-full text-slate-500 text-sm mt-4 hover:text-white pb-2">關閉</button></div></div>

    <!-- Toast & Stub -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-[#181b21] text-white px-6 py-4 rounded-2xl shadow-2xl z-[70] opacity-0 pointer-events-none transition-all duration-300 text-sm font-bold flex items-center gap-3 border border-slate-700"><i class="fas fa-check-circle text-blue-500 text-lg"></i><span id="toast-msg">操作成功</span></div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, deleteDoc, doc, setDoc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBJ0qf4FyJ-Ln8uTlVfyqq84IAeUsTWSCo",
            authDomain: "recordmachine.firebaseapp.com",
            projectId: "recordmachine",
            storageBucket: "recordmachine.firebasestorage.app",
            messagingSenderId: "817708522720",
            appId: "1:817708522720:web:5e3b876ce170012d53c485",
            measurementId: "G-WR49R47LN1"
        };

        let app, auth, db;
        try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } 
        catch (e) { console.error("Init Error", e); }
        
        // --- 1. DEFINE VARIABLES ---
        let currentUser = null, isGuest = false;
        let recordsData = [], videoData = [], timesheetData = [], sentInvitations = [], receivedInvitations = [];
        let financeChart = null;
        let settings = { nickname: '', venues: ['旺角中心', '現時點', '信和中心'], sources: ['淘寶', '本地批發', '日本代購'] };
        let sharingSettings = { records: true, videos: true, checkin: true, settlement: true }; 
        let editingSettings = null, activeEdit = null, workStart = null;
        let currentViewMode = 'mine', sharedTargetUid = null, activeInvitationId = null, unsubscribeSharedMonitor = null, unsubscribes = [];

        // --- 2. DEFINE HELPER FUNCTIONS (Pure Logic) ---
        const showToast = (msg) => {
            const t = document.getElementById('toast');
            if(t) {
                document.getElementById('toast-msg').innerText = msg;
                t.classList.remove('opacity-0', 'translate-y-4');
                setTimeout(() => t.classList.add('opacity-0', 'translate-y-4'), 3000);
            }
        };

        const updateUIForUser = () => {
            const nameEl = document.getElementById('display-username');
            if(nameEl) nameEl.innerText = currentUser.displayName || settings.nickname || "使用者";
            const emailEl = document.getElementById('display-email');
            if(emailEl) emailEl.innerText = currentUser.email;
            const badgeEl = document.getElementById('db-status-badge');
            if(badgeEl) {
                if(!isGuest) badgeEl.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span> ONLINE`;
                else badgeEl.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-yellow-500"></span> LOCAL`;
            }
        };

        const getPath = (col) => { 
            const targetUid = (currentViewMode === 'shared' && sharedTargetUid) ? sharedTargetUid : currentUser.uid;
            return `artifacts/${firebaseConfig.appId}/users/${targetUid}/${col}`; 
        };

        const createCustomSelect = (cId, iId, opts, ph) => { 
            const container = document.getElementById(cId);
            if(!container) return;
            const currentVal = opts[0] || '';
            container.innerHTML = `<label class="text-[10px] font-bold text-slate-400 uppercase tracking-wider block">${ph.replace('選擇','')}</label><div class="custom-select-wrapper mt-1.5"><div class="custom-select-trigger modern-input rounded-lg p-2.5 text-sm flex justify-between items-center" onclick="toggleSelect('${iId}')"><span id="${iId}-display">${currentVal||ph}</span><i class="fas fa-chevron-down text-xs text-slate-500"></i></div><input type="hidden" id="${iId}" value="${currentVal}"><div id="${iId}-options" class="custom-select-options">${opts.map(o=>`<div class="custom-option" onclick="selectOption('${iId}','${o}')">${o}</div>`).join('')}</div></div>`; 
        };

        const renderCustomSelectors = () => { createCustomSelect('venue-selector-container', 'income-venue', settings.venues, '選擇場地'); createCustomSelect('stock-source-selector-container', 'stock-source', settings.sources, '選擇來源'); };

        const renderEditTags = (t) => {
            document.getElementById(t==='venues'?'venues-list':'sources-list').innerHTML = editingSettings[t].map((x,i) => 
                `<div class="tag-chip"><span>${x}</span><i class="fas fa-times cursor-pointer hover:text-white" onclick="removeSettingItem('${t}',${i})"></i></div>`
            ).join('');
        };

        const calculateAggregates = () => {
            const now = new Date();
            let m = 0;
            recordsData.forEach(r => {
                if (r.type === 'income' && new Date(r.date).getMonth() === now.getMonth()) {
                    m += Number(r.amount);
                }
            });
            const el = document.getElementById('projected-income');
            if(el) el.innerText = '$' + m;
        };

        const updateSettlement = () => {
            let m = 0, s = 0, v = 0, w = 0;
            recordsData.forEach(r => {
                if (r.type === 'income') m += Number(r.amount);
                else s += Number(r.amount);
            });
            videoData.forEach(i => v += Number(i.amount));
            timesheetData.forEach(t => w += Number(t.wage));
            const g = m + v + w;
            
            const elNet = document.getElementById('settle-net-income'); if(elNet) elNet.innerText = `$${g - s}`;
            const elTotal = document.getElementById('settle-total-income'); if(elTotal) elTotal.innerText = `$${g}`;
            const elMachine = document.getElementById('settle-machine-net'); if(elMachine) elMachine.innerText = `$${m}`;
            const elStock = document.getElementById('settle-stock'); if(elStock) elStock.innerText = `$${s}`;
            const elVideo = document.getElementById('settle-video'); if(elVideo) elVideo.innerText = `$${v}`;
            const elWages = document.getElementById('settle-wages'); if(elWages) elWages.innerText = `$${w}`;

            if(financeChart) financeChart.destroy();
            const ctx = document.getElementById('financeChart').getContext('2d');
            financeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['機台', '影片', '打卡', '入貨'],
                    datasets: [{
                        data: [m, v, w, s],
                        backgroundColor: ['#3b82f6', '#8b5cf6', '#10b981', '#ef4444'],
                        borderColor: '#1e293b',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: '#94a3b8', font: {family: "'Noto Sans HK'"} } } }
                }
            });
        };

        const renderRecentRecords = () => {
            const all = [...recordsData.map(r=>({...r, cat:'rec', time:new Date(r.date||r.createdAt).getTime()})), ...videoData.map(v=>({...v, cat:'vid', time:new Date(v.date||v.createdAt).getTime()})), ...timesheetData.map(t=>({...t, cat:'chk', time:new Date(t.start||t.createdAt).getTime()}))].sort((a,b)=>b.time-a.time).slice(0,10);
            document.getElementById('recent-records-list').innerHTML = all.length ? all.map(i => {
                let ic, col, ti, sub, amt, act;
                if(i.cat==='rec') { const inc=i.type==='income'; ic=inc?'fa-gamepad':'fa-box'; col=inc?'text-blue-400':'text-red-400'; ti=inc?i.venue:i.name; sub=i.date; amt=(inc?'+':'-')+'$'+i.amount; act=`openEditRecord('${i.id}')`; }
                else if(i.cat==='vid') { ic='fa-video'; col='text-purple-400'; ti=i.title; sub=new Date(i.date).toLocaleDateString(); amt='+$25'; act=`openEditVideo('${i.id}')`; }
                else { ic='fa-clock'; col='text-green-400'; ti='打卡工資'; sub=new Date(i.start).toLocaleDateString(); amt='+$'+i.wage; act=`openEditCheckin('${i.id}')`; }
                return `<div class="modern-card p-4 rounded-xl flex justify-between items-center mb-3 border border-white/5 relative z-20 cursor-pointer hover:bg-white/5 transition group" onclick="${act}"><div class="flex items-center gap-4"><div class="w-10 h-10 rounded-xl bg-white/5 ${col} flex items-center justify-center border border-white/5"><i class="fas ${ic}"></i></div><div><div class="font-bold text-slate-200 text-sm group-hover:text-white transition-colors">${ti}</div><div class="text-[10px] text-slate-500 font-mono mt-0.5">${sub}</div></div></div><div class="font-mono font-bold ${col} text-lg">${amt}</div></div>`;
            }).join('') : '<div class="text-center text-slate-500 text-xs py-4">暫無活動</div>';
        };

        const renderFolderBlock = (t,k,recs,tot,col) => {
            const tree={}; recs.forEach(r=>{if(!r.date)return; const[y,m]=r.date.split('-'); if(!tree[y])tree[y]={}; if(!tree[y][m])tree[y][m]=[]; tree[y][m].push(r);});
            return `<div class="modern-card rounded-2xl overflow-hidden mb-4 border border-white/5"><div class="p-5 bg-white/5 font-bold text-white border-b border-white/5 flex justify-between items-center cursor-pointer hover:bg-white/10 transition" onclick="document.getElementById('f-${k}').classList.toggle('hidden')"><span class="flex items-center gap-3 text-lg"><i class="fas ${k==='income'?'fa-gamepad':'fa-box'} ${col}"></i> ${t}</span><span class="font-mono text-sm ${col} bg-black/30 px-3 py-1 rounded-lg border border-white/5">$${tot}</span></div><div id="f-${k}" class="hidden">${Object.keys(tree).sort((a,b)=>b-a).map(y=>`<div class="mb-2"><div class="p-3 bg-black/20 text-slate-400 border-b border-white/5 flex justify-between cursor-pointer hover:text-white transition" onclick="document.getElementById('y-${k}-${y}').classList.toggle('hidden')"><span class="text-xs font-bold tracking-wider ml-2">${y} 年</span><span class="font-mono text-xs">$${Object.values(tree[y]).flat().reduce((s,r)=>s+Number(r.amount),0)}</span></div><div id="y-${k}-${y}" class="hidden pl-2 border-l border-white/10 ml-4 my-2">${Object.keys(tree[y]).sort((a,b)=>b-a).map(m=>`<div class="p-2.5 border-b border-white/5 cursor-pointer group" onclick="document.getElementById('m-${k}-${y}-${m}').classList.toggle('hidden')"><div class="flex justify-between items-center"><span class="text-sm text-slate-300 group-hover:text-blue-400 transition-colors"><i class="fas fa-folder mr-2 text-yellow-500/80"></i>${m} 月</span><span class="font-mono text-xs ${col}">$${tree[y][m].reduce((s,r)=>s+Number(r.amount),0)}</span></div></div><div id="m-${k}-${y}-${m}" class="hidden bg-black/20 p-2 space-y-1 rounded-b-lg">${tree[y][m].map(i=>`<div class="flex justify-between p-2 rounded-lg hover:bg-white/5 text-xs cursor-pointer z-20 relative" onclick="openEditRecord('${i.id}')"><span class="text-slate-400">${i.date.slice(5)} ${k==='income'?i.venue:i.name}</span><span class="${col} font-mono">$${i.amount}</span></div>`).join('')}</div>`).join('')}</div></div>`).join('')}</div></div>`;
        };

        const renderDataTree = () => {
            const c = document.getElementById('data-tree-container');
            if(!recordsData.length) { c.innerHTML='<div class="text-center text-slate-500 mt-10">暫無數據</div>'; return; }
            const inc = recordsData.filter(r=>r.type==='income'); const st = recordsData.filter(r=>r.type==='stock');
            c.innerHTML = renderFolderBlock('機台收入','income',inc,inc.reduce((s,r)=>s+Number(r.amount),0),'text-blue-400') + renderFolderBlock('網上入貨','stock',st,st.reduce((s,r)=>s+Number(r.amount),0),'text-red-400');
        };

        const renderVideos = () => {
            const list = document.getElementById('video-list');
            if (videoData.length === 0) { list.innerHTML = '<div class="text-center text-slate-500 text-xs py-4">本月尚無影片</div>'; return; }
            list.innerHTML = videoData.slice(0, 10).map(v => `<div class="modern-card p-4 rounded-xl flex justify-between items-center cursor-pointer border border-white/5 hover:border-purple-500/30 transition" onclick="openEditVideo('${v.id}')"><div class="flex items-center gap-3"><div class="bg-purple-500/10 text-purple-400 w-10 h-10 rounded-lg flex items-center justify-center text-lg"><i class="fas fa-play"></i></div><div><div class="font-bold text-slate-200 text-sm">${v.title}</div><div class="text-[10px] text-slate-500 font-mono">${v.date}</div></div></div><div class="text-purple-400 font-bold font-mono text-sm">+$25</div></div>`).join('');
        };

        const renderCheckins = () => {
             const list = document.getElementById('checkin-list');
             if (timesheetData.length === 0) { list.innerHTML = '<div class="text-center text-slate-500 text-xs py-2">無打卡記錄</div>'; return; }
             list.innerHTML = timesheetData.slice().reverse().map(t => `<div class="flex justify-between items-center p-3 bg-white/5 rounded-lg border border-white/5 mb-2 cursor-pointer hover:bg-white/10" onclick="openEditCheckin('${t.id}')"><div class="flex flex-col"><span class="text-[10px] text-slate-400 font-bold uppercase font-mono">${new Date(t.start).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${new Date(t.end).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</span><span class="text-[10px] text-slate-500">${new Date(t.start).toLocaleDateString()}</span></div><span class="font-bold text-green-400 font-mono text-sm">+$${t.wage}</span></div>`).join('');
        };
        
        const renderReceivedInvites = () => {
            const list = document.getElementById('notif-list'); const userList = document.getElementById('shared-users-list');
            list.innerHTML = ''; userList.innerHTML = ''; let hasAccepted = false;
            receivedInvitations.forEach(inv => {
                if(inv.status === 'pending') {
                    list.innerHTML += `<div class="p-4 bg-white/5 rounded-xl border border-white/5 mb-2"><div class="flex justify-between items-center mb-2"><span class="text-sm text-white font-bold">${inv.fromName}</span><span class="text-[10px] bg-blue-900/50 text-blue-400 px-2 py-1 rounded-full border border-blue-500/30">新邀請</span></div><p class="text-xs text-slate-400 mb-4">邀請您查看營收資料。</p><div class="flex gap-3"><button onclick="acceptInvite('${inv.id}')" class="flex-1 bg-blue-600 text-white text-xs py-2 rounded-lg hover:bg-blue-500">接受</button><button onclick="rejectInvite('${inv.id}')" class="flex-1 bg-white/10 text-slate-300 text-xs py-2 rounded-lg hover:bg-white/20">拒絕</button></div></div>`;
                } else if (inv.status === 'accepted') {
                    hasAccepted = true;
                    userList.innerHTML += `<button onclick="switchToSharedView('${inv.fromUid}', '${inv.fromName}', '${inv.id}')" class="w-full text-left p-4 bg-white/5 hover:bg-indigo-500/10 rounded-xl border border-white/5 hover:border-indigo-500 transition flex items-center justify-between group"><span class="text-sm text-slate-300 group-hover:text-white font-bold">${inv.fromName}</span><i class="fas fa-arrow-right text-slate-500 group-hover:text-indigo-400"></i></button>`;
                }
            });
            if(!receivedInvitations.length) list.innerHTML = '<div class="text-center text-slate-500 text-xs py-4">暫無通知</div>';
            document.getElementById('shared-view-selector').classList.toggle('hidden', !hasAccepted);
        };
        
        const renderSentInvites = () => {
            document.getElementById('sent-invites-list').innerHTML = sentInvitations.map(inv => `<div class="flex justify-between items-center p-3 bg-white/5 rounded-xl border border-white/5"><div><div class="text-xs text-white font-bold mb-1">${inv.toEmail}</div><div class="text-[10px] ${inv.status==='accepted'?'text-green-400':'text-yellow-400'} flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full ${inv.status==='accepted'?'bg-green-400':'bg-yellow-400'}"></span> ${inv.status==='accepted'?'已接受':'等待中'}</div></div><button onclick="rejectInvite('${inv.id}')" class="text-red-400 hover:text-red-300 text-xs border border-red-500/30 px-3 py-1.5 rounded-lg hover:bg-red-500/10 transition">撤銷</button></div>`).join('');
        };
        
        const restoreSession = (iso) => {
            workStart = new Date(iso);
            document.getElementById('btn-clock-in').classList.add('opacity-50');
            document.getElementById('btn-clock-in').disabled = true;
            document.getElementById('btn-clock-out').classList.remove('cursor-not-allowed','bg-slate-700','text-slate-500');
            document.getElementById('btn-clock-out').classList.add('bg-red-600','text-white');
            document.getElementById('btn-clock-out').disabled = false;
        };

        const resetClockUI = () => {
            workStart = null;
            document.getElementById('btn-clock-in').classList.remove('opacity-50');
            document.getElementById('btn-clock-in').disabled = false;
            document.getElementById('btn-clock-out').classList.add('cursor-not-allowed','bg-slate-700','text-slate-500');
            document.getElementById('btn-clock-out').classList.remove('bg-red-600','text-white');
            document.getElementById('btn-clock-out').disabled = true;
        };

        const renderAll = () => {
            renderRecentRecords(); renderDataTree(); renderVideos(); renderCheckins(); calculateAggregates(); updateSettlement();
        };

        const openEditModal = (id, type, data, fields) => { 
            activeEdit = { id, type, data }; 
            document.getElementById('edit-form-container').innerHTML = fields.map(f => `<div><label class="text-[10px] text-slate-500 uppercase">${f.label}</label><input type="${f.type}" id="${f.id}" value="${f.val}" class="w-full modern-input rounded-lg p-3 text-sm ${f.type==='number'?'font-mono':''}"></div>`).join(''); 
            document.getElementById('modal-edit').classList.remove('hidden'); 
        };
        
        const updateNotifDot = () => { const hasPending = receivedInvitations.some(i => i.status === 'pending'); document.getElementById('notif-dot').classList.toggle('active', hasPending); };

        const saveGuestData = () => {
            const ls = localStorage;
            ls.setItem('guest_records', JSON.stringify(recordsData));
            ls.setItem('guest_videos', JSON.stringify(videoData));
            ls.setItem('guest_timesheets', JSON.stringify(timesheetData));
            ls.setItem('guest_settings', JSON.stringify(settings));
            renderAll();
        };

        const exitSharedMode = (reason) => { if(currentViewMode === 'mine') return; alert(reason || "已退出"); window.switchToMyData(); };

        // --- 3. ASSIGN TO WINDOW (Safe Execution) ---
        window.showToast = showToast;
        window.toggleSelect = (id) => { const el=document.getElementById(id+'-options'); const open=el.classList.contains('open'); document.querySelectorAll('.custom-select-options').forEach(e=>e.classList.remove('open')); if(!open) el.classList.add('open'); };
        window.selectOption = (id,v) => { document.getElementById(id).value=v; document.getElementById(id+'-display').innerText=v; document.getElementById(id+'-options').classList.remove('open'); };

        window.navTo = (t) => {
            document.querySelectorAll('.page-section').forEach(e => e.classList.add('hidden'));
            const targetPage = document.getElementById('page-' + t);
            if (targetPage) targetPage.classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(e => { e.classList.remove('active', 'text-cyan-400'); e.classList.add('text-slate-500'); });
            const activeBtn = document.querySelector(`.nav-item[data-target="${t}"]`);
            if (activeBtn) activeBtn.classList.add('active', 'text-cyan-400');
            if (t === 'settlement') updateSettlement();
        };

        window.toggleAuthView = (v) => { document.getElementById(v==='register'?'auth-view-login':'auth-view-register').classList.add('hidden'); document.getElementById(v==='register'?'auth-view-register':'auth-view-login').classList.remove('hidden'); };
        window.handleGoogleLogin = async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch (e) { window.showToast("登入失敗: " + e.message); } };
        window.handleEmailLogin = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value); } catch(e){ window.showToast(e.message); } };
        window.handleEmailRegister = async () => { try { await createUserWithEmailAndPassword(auth, document.getElementById('reg-email').value, document.getElementById('reg-pass').value); window.showToast("註冊成功"); } catch(e){ window.showToast(e.message); } };
        
        window.handleGuestLogin = () => { 
            isGuest = true; 
            document.getElementById('auth-screen').classList.add('hidden'); 
            document.getElementById('app-container').classList.remove('hidden'); 
            currentUser = { uid: 'guest', displayName: 'Guest', email: 'guest@local' }; 
            updateUIForUser(); 
            loadGuestData(); 
        };
        
        window.handleLogout = async () => { if(!isGuest) await signOut(auth); location.reload(); };
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
        window.openSettingsModal = () => { editingSettings = JSON.parse(JSON.stringify(settings)); document.getElementById('settings-nickname').value = editingSettings.nickname || ''; renderEditTags('venues'); renderEditTags('sources'); document.getElementById('modal-settings').classList.remove('hidden'); };
        window.openShareModal = () => { document.getElementById('share-toggle-records').checked = sharingSettings.records !== false; document.getElementById('share-toggle-videos').checked = sharingSettings.videos !== false; document.getElementById('share-toggle-checkin').checked = sharingSettings.checkin !== false; document.getElementById('share-toggle-settlement').checked = sharingSettings.settlement !== false; document.getElementById('modal-share').classList.remove('hidden'); };
        window.openNotifications = () => document.getElementById('modal-notif').classList.remove('hidden');

        window.saveSharingSettings = async () => {
            sharingSettings = {
                records: document.getElementById('share-toggle-records').checked,
                videos: document.getElementById('share-toggle-videos').checked,
                checkin: document.getElementById('share-toggle-checkin').checked,
                settlement: document.getElementById('share-toggle-settlement').checked
            };
            if(isGuest) { saveGuestData(); window.showToast("訪客設定已保存"); } 
            else { await setDoc(doc(db, getPath('settings'), 'sharing'), sharingSettings, {merge:true}); window.showToast("權限已更新"); }
            window.closeModal('modal-share');
        };
        window.addSettingItem=(t)=>{const i=document.getElementById(t==='venues'?'new-venue-input':'new-source-input');if(i.value){editingSettings[t].push(i.value);i.value='';renderEditTags(t);}};
        window.removeSettingItem=(t,ix)=>{editingSettings[t].splice(ix,1);renderEditTags(t);};
        window.saveSettings=async()=>{settings=editingSettings;if(isGuest)saveGuestData();else await setDoc(doc(db,getPath('settings'),'config'),settings,{merge:true});updateUIForUser();renderCustomSelectors();window.closeModal('modal-settings');};
        window.switchInputMode=(m)=>{const bg=document.getElementById('toggle-bg'); if(m==='income'){bg.style.transform='translateX(0)';document.getElementById('form-income').classList.remove('hidden');document.getElementById('form-stock').classList.add('hidden');}else{bg.style.transform='translateX(100%)';document.getElementById('form-income').classList.add('hidden');document.getElementById('form-stock').classList.remove('hidden');}};
        window.toggleMachineType=()=>{const t=document.querySelector('input[name="machineType"]:checked').value;document.getElementById('standard-amount-input').classList.toggle('hidden',t!=='standard');document.getElementById('mini-amount-input').classList.toggle('hidden',t!=='mini');window.calculateTotalIncome();};
        window.calculateTotalIncome=()=>{const t=document.querySelector('input[name="machineType"]:checked').value;let tot=t==='standard'?(Number(document.getElementById('income-amount').value)||0):((Number(document.getElementById('income-top').value)||0)+(Number(document.getElementById('income-bottom').value)||0));document.getElementById('income-display-total').innerText='$'+tot;return tot;};
        
        window.saveRecord = async (type) => {
            const data = { type, createdAt: new Date().toISOString() };
            if(type==='income') { data.date=document.getElementById('income-date').value; data.venue=document.getElementById('income-venue').value; data.machineType=document.querySelector('input[name="machineType"]:checked').value; data.amount=Number(document.getElementById('income-display-total').innerText.replace('$','')); data.remarks=document.getElementById('income-remarks').value; if(!data.date||!data.venue) return window.showToast("資料不完整"); }
            else { data.date=document.getElementById('stock-date').value; data.source=document.getElementById('stock-source').value; data.name=document.getElementById('stock-name').value; data.qty=Number(document.getElementById('stock-qty').value); data.amount=Number(document.getElementById('stock-cost').value); if(!data.date||!data.source) return window.showToast("資料不完整"); }
            if(isGuest) { data.id='guest_'+Date.now(); recordsData.unshift(data); saveGuestData(); }
            else await addDoc(collection(db, getPath('records')), data);
            window.showToast("已儲存");
            if(type==='income') { document.getElementById('income-amount').value=''; document.getElementById('income-top').value=''; document.getElementById('income-bottom').value=''; document.getElementById('income-display-total').innerText='$0'; }
            else document.getElementById('stock-cost').value='';
        };

        window.openEditRecord = (id) => { const r = recordsData.find(x => x.id === id); if(!r) return; openEditModal(id, r.type, r, [ { id: 'edit-date', label: '日期', type: 'date', val: r.date }, { id: 'edit-amount', label: '金額', type: 'number', val: r.amount }, { id: 'edit-remark', label: '備註/名稱', type: 'text', val: r.remarks || r.name } ]); };
        window.openEditVideo = (id) => { const v = videoData.find(x => x.id === id); if(!v) return; activeEdit = { id, type: 'video', data: v }; document.getElementById('edit-form-container').innerHTML = `<div><label class="text-[10px] text-slate-500 uppercase">標題</label><input type="text" id="edit-title" value="${v.title}" class="w-full modern-input rounded-lg p-3 text-sm"></div><div><label class="text-[10px] text-slate-500 uppercase">日期</label><input type="date" id="edit-date" value="${v.date}" class="w-full modern-input rounded-lg p-3 text-sm"></div>`; document.getElementById('modal-edit').classList.remove('hidden'); };
        window.openEditCheckin = (id) => { const t = timesheetData.find(x => x.id === id); if(!t) return; activeEdit = { id, type: 'checkin', data: t }; document.getElementById('edit-form-container').innerHTML = `<div><label class="text-[10px] text-slate-500 uppercase">工資 ($)</label><input type="number" id="edit-wage" value="${t.wage}" class="w-full modern-input rounded-lg p-3 text-sm font-mono"></div>`; document.getElementById('modal-edit').classList.remove('hidden'); };
        window.updateCurrentRecord = async () => { if(!activeEdit) return; const { id, type } = activeEdit; const updates = {}; const mapping = { 'edit-date': 'date', 'edit-amount': 'amount', 'edit-remark': (type==='income'?'remarks':'name'), 'edit-title': 'title', 'edit-wage': 'wage' }; for (const [eid, field] of Object.entries(mapping)) { if(document.getElementById(eid)) updates[field] = (field==='amount'||field==='wage') ? Number(document.getElementById(eid).value) : document.getElementById(eid).value; } if(isGuest) { if(type === 'video') { const idx = videoData.findIndex(x=>x.id===id); if(idx>-1) Object.assign(videoData[idx], updates); } else if(type === 'checkin') { const idx = timesheetData.findIndex(x=>x.id===id); if(idx>-1) Object.assign(timesheetData[idx], updates); } else { const idx = recordsData.findIndex(x=>x.id===id); if(idx>-1) Object.assign(recordsData[idx], updates); } saveGuestData(); } else { const col = type === 'video' ? 'videos' : (type === 'checkin' ? 'timesheets' : 'records'); await updateDoc(doc(db, getPath(col), id), updates); } window.showToast("已更新"); closeModal('modal-edit'); };
        window.deleteCurrentRecord = async () => { if(!activeEdit) return; const { id, type } = activeEdit; if(isGuest) { if(type === 'video') videoData = videoData.filter(x=>x.id!==id); else if(type === 'checkin') timesheetData = timesheetData.filter(x=>x.id!==id); else recordsData = recordsData.filter(x=>x.id!==id); saveGuestData(); } else { const col = type === 'video' ? 'videos' : (type === 'checkin' ? 'timesheets' : 'records'); await deleteDoc(doc(db, getPath(col), id)); } window.showToast("已刪除"); closeModal('modal-edit'); };
        
        window.saveVideoRecord = async () => {
            const title = document.getElementById('video-title').value; const date = document.getElementById('video-date').value;
            if(!title || !date) return window.showToast("請填寫完整");
            const data = { title, date, amount: 25, type: 'video', createdAt: new Date().toISOString() };
            if(isGuest) { data.id='vid_'+Date.now(); videoData.unshift(data); saveGuestData(); } 
            else await addDoc(collection(db, getPath('videos')), data);
            window.showToast("已新增"); document.getElementById('video-title').value = '';
        };

        window.clockIn=async()=>{const n=new Date().toISOString();restoreSession(n);if(isGuest)localStorage.setItem('guest_active_session',n);else await setDoc(doc(db,getPath('system'),'status'),{activeSessionStart:n},{merge:true});window.showToast("上班");};
        window.clockOut=async()=>{if(!workStart)return;const e=new Date();const m=(e-workStart)/1000/60;const w=Math.round(m/30)*25;const r={type:'checkin',start:workStart.toISOString(),end:e.toISOString(),wage:w,createdAt:e.toISOString()};if(isGuest){timesheetData.push({...r,id:'s'+Date.now()});localStorage.removeItem('guest_active_session');saveGuestData();}else{await addDoc(collection(db,getPath('timesheets')),r);await updateDoc(doc(db,getPath('system'),'status'),{activeSessionStart:null});}resetClockUI();window.showToast(`下班 (+$${w})`);renderCheckins();updateSettlement();};
        
        window.switchToMyData = () => { if(unsubscribeSharedMonitor) unsubscribeSharedMonitor(); currentViewMode = 'mine'; sharedTargetUid = null; activeInvitationId = null; document.getElementById('shared-mode-banner').classList.add('hidden'); updateUIForUser(); document.getElementById('main-header').classList.remove('border-indigo-500'); document.querySelectorAll('.write-action').forEach(el => el.classList.remove('hidden')); window.closeModal('modal-notif'); initRealtimeListeners(); window.showToast("已返回我的資料"); };
        window.switchToSharedView = (targetUid, targetName, inviteId) => { if(unsubscribeSharedMonitor) unsubscribeSharedMonitor(); unsubscribeSharedMonitor = onSnapshot(doc(db, `artifacts/${firebaseConfig.appId}/public/data/invitations`, inviteId), (snap) => { if(!snap.exists() || snap.data().status !== 'accepted') exitSharedMode("權限已變更"); }); currentViewMode = 'shared'; sharedTargetUid = targetUid; activeInvitationId = inviteId; document.getElementById('shared-mode-banner').classList.remove('hidden'); document.getElementById('display-username').innerText = `${targetName} (共享)`; document.getElementById('main-header').classList.add('border-indigo-500'); document.querySelectorAll('.write-action').forEach(el => el.classList.add('hidden')); window.closeModal('modal-notif'); initRealtimeListeners(); window.showToast(`已切換至 ${targetName}`); };
        window.exitSharedMode = exitSharedMode;
        
        function loadGuestData() {
            const ls = localStorage;
            recordsData = JSON.parse(ls.getItem('guest_records') || '[]');
            videoData = JSON.parse(ls.getItem('guest_videos') || '[]');
            timesheetData = JSON.parse(ls.getItem('guest_timesheets') || '[]');
            const s = JSON.parse(ls.getItem('guest_settings')); if(s) settings = s;
            if(ls.getItem('guest_active_session')) restoreSession(ls.getItem('guest_active_session'));
            renderCustomSelectors(); renderAll();
        }

        // Listeners
        document.addEventListener('click', e => { if(!e.target.closest('.custom-select-wrapper')) document.querySelectorAll('.custom-select-options').forEach(el=>el.classList.remove('open')); });
        setInterval(()=>{const now=new Date();document.getElementById('clock-time').innerText=now.toLocaleTimeString('en-GB',{hour12:false});document.getElementById('clock-date').innerText=now.toLocaleDateString('en-GB',{weekday:'short',year:'numeric',month:'short',day:'numeric'});},1000);

        document.getElementById('income-date').valueAsDate=new Date();document.getElementById('stock-date').valueAsDate=new Date();document.getElementById('video-date').valueAsDate=new Date();
    </script>
</body>
</html>